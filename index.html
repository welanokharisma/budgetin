<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Budgetin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Charts CDN -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <style>
    /* ---------------------------------------------------------------------- */
    /* 1. DEFINISI TEMA (Menggunakan Tema Hijau Soft Default) */
    /* ---------------------------------------------------------------------- */
    
    :root {
      /* Warna Dasar Tema Hijau-Putih (Light Soft Theme) */
      --color-white-bg: #FFFFFF;
      --color-light-bg: #FAF9F6;
      --color-dark-text: #333333;
      --color-green-primary: #7CD18B;
      --color-red-expense: #F0939A;
      --color-border-classic: #E0E0E0;
      --color-balance-blue: #8AB8DE;
      --color-header-green: #6AA573;

      /* Mapping ke Variabel Aplikasi */
      --bg-color: var(--color-light-bg);
      --card-bg: var(--color-white-bg);
      --text-color: var(--color-dark-text);
      --income-color: var(--color-green-primary);
      --expense-color: var(--color-red-expense);
      --balance-color: var(--color-balance-blue);
      --primary-accent: var(--color-header-green);
      --chart-bg: var(--color-white-bg);
      --chart-text: var(--color-dark-text);
      
      /* Font Family */
      --font-family-sans: 'Inter', sans-serif;
    }

    /* ---------------------------------------------------------------------- */
    /* 2. BASE STYLING & UTILITIES */
    /* ---------------------------------------------------------------------- */
    
    body {
      font-family: var(--font-family-sans);
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    /* Global Card Style */
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--color-border-classic);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }

    /* Button Styling */
    .btn-primary {
      background-color: var(--primary-accent);
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background-color: #5a8a61; /* sedikit lebih gelap */
    }

    /* Custom Loading Spinner (agar terlihat profesional) */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Styling untuk tombol Navigasi Period (Agar terlihat lebih baik di mobile) */
    .period-button {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Styling untuk Navigasi Menu */
    .nav-link {
        padding: 0.75rem 1.25rem;
        transition: all 0.2s;
        border-radius: 0.5rem;
        font-weight: 600;
        text-align: center;
    }
    .nav-link.active {
        background-color: var(--primary-accent);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .nav-link:not(.active):hover {
        background-color: #e5e7eb;
    }

    /* Simple auth container */
    #authContainer {
      max-width: 520px;
      margin: 3rem auto;
    }
  </style>
</head>

<body class="min-h-screen p-2 sm:p-4 md:p-6">
  <!-- Loading Overlay Awal -->
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center transition-opacity duration-300">
    <div class="spinner"></div>
    <p class="ml-4 text-lg font-semibold text-gray-700">Memuat Aplikasi...</p>
  </div>

  <!-- AUTH (Login/Register) -->
  <div id="authWrapper" class="hidden">
    <div id="authContainer" class="bg-white p-6 rounded-xl shadow-lg">
      <h1 class="text-3xl font-extrabold mb-2" style="color: var(--primary-accent);">Budgetin</h1>
      <p class="text-sm text-gray-600 mb-4">Lacak aliran uangmu. Masuk dengan email & password.</p>

      <div class="mb-4">
        <div class="flex gap-2">
          <button id="btnShowLogin" class="nav-link active">Login</button>
          <button id="btnShowRegister" class="nav-link">Register</button>
        </div>
      </div>

      <div id="authForms">
        <!-- Login Form -->
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="loginEmail" type="email" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input id="loginPassword" type="password" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="flex justify-between items-center">
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Masuk</button>
            <a href="#" id="forgotPasswordLink" class="text-sm text-gray-600 underline">Lupa password?</a>
          </div>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="space-y-3 hidden">
          <div>
            <label class="block text-sm font-medium mb-1">Nama Lengkap</label>
            <input id="regName" type="text" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="regEmail" type="email" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input id="regPassword" type="password" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="flex justify-end">
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Daftar</button>
          </div>
        </form>
      </div>

      <div id="authMessage" class="mt-4 text-sm text-gray-600"></div>
    </div>
  </div>

  <!-- Konten Utama Aplikasi -->
  <div id="mainContent" class="hidden max-w-7xl mx-auto">
    
    <!-- Header dan Navigasi -->
    <header class="mb-6 p-4 rounded-xl bg-white shadow-lg">
      <!-- Judul dan User ID -->
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
        <h1 class="text-3xl font-extrabold" style="color: var(--primary-accent);">Budgetin</h1>
        <div class="flex items-center gap-3">
          <p id="userIdDisplay" class="text-xs mt-2 sm:mt-0 p-1 bg-gray-100 rounded-full inline-block text-gray-600"></p>
          <button id="btnSignOut" class="text-sm text-red-500 hover:text-red-700">Logout</button>
        </div>
      </div>

      <!-- Menu Navigasi (Tabs) -->
      <nav class="flex flex-wrap justify-center sm:justify-start gap-2">
        <button class="nav-link active" data-page="dashboard">Dashboard</button>
        <button class="nav-link" data-page="transaksi">Transaksi</button>
        <button class="nav-link" data-page="budget">Budget</button>
        <button class="nav-link" data-page="pengaturan">Pengaturan</button>
      </nav>
    </header>

    <!-- Konten Halaman (Dynamic Content) -->
    <div id="pageContainer">
      <!-- Konten spesifik halaman akan di-render di sini -->
    </div>
    
  </div>

  <!-- Modal untuk notifikasi (Ganti alert/confirm) -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center p-4" onclick="closeModal()">
    <div class="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl" onclick="event.stopPropagation()">
      <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">Notifikasi</h3>
      <p id="modalMessage" class="text-gray-600 mb-4"></p>
      <div class="flex justify-end space-x-3">
        <button id="modalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hidden">Konfirmasi</button>
        <button id="modalCloseBtn" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Tutup</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT: Supabase integration and app logic -->
  <script type="module">
    console.log('üöÄ Starting Budgetin Application...');

    // Singleton Supabase Service untuk menghindari multiple instances
    class SupabaseService {
      static instance = null;
      
      static async getInstance() {
        if (!this.instance) {
          try {
            const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
            
            this.instance = createClient(
              'https://xzlggtyvgnyzzofgudwa.supabase.co',
              'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6bGdndHl2Z255enpvZmd1ZHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MDk0MjcsImV4cCI6MjA3NzQ4NTQyN30.x77c3j7TfL5_tQStYNSurhEC6gUDIasuVUk8YpJAi5E',
              {
                auth: {
                  persistSession: true,
                  autoRefreshToken: true,
                  detectSessionInUrl: true,
                  storage: localStorage
                }
              }
            );
            console.log('‚úÖ Supabase instance created successfully');
          } catch (error) {
            console.error('‚ùå Failed to create Supabase instance:', error);
            throw error;
          }
        }
        return this.instance;
      }
    }

    // Initialize Supabase dengan error handling
    let supabase;
    try {
      supabase = await SupabaseService.getInstance();
      console.log('‚úÖ Supabase initialized successfully');
    } catch (error) {
      console.error('‚ùå Supabase initialization failed:', error);
      document.getElementById('loadingOverlay').innerHTML = `
        <div class="text-center">
          <div class="text-red-500 text-xl mb-4">‚ùå Error Initializing App</div>
          <p class="text-gray-600 mb-2">Failed to connect to database.</p>
          <p class="text-gray-600 mb-4">Please check your internet connection and refresh the page.</p>
          <button onclick="window.location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Refresh Page</button>
        </div>
      `;
    }

    // App state
    let user = null;
    let userId = null;
    let isAuthReady = false;

    let currentTransactions = [];
    let currentBudgets = [];
    let currentCategories = { expense: [], incomeSource: [], account: [] };

    let currentPage = 'dashboard';
    let currentPeriod = new Date().toISOString().substring(0,7); // YYYY-MM

    // Colors from CSS
    const expenseColor = '#F0939A';
    const incomeColor = '#7CD18B';
    const balanceColor = '#8AB8DE';
    const primaryAccent = '#6AA573';

    // Utility: format currency (IDR)
    function formatRupiah(number) {
      if (number === null || number === undefined || isNaN(number)) return 'Rp -';
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(number);
    }

    // Modal helpers
    function showModal(title, message, isConfirm = false, onConfirm = () => {}) {
      const modal = document.getElementById('modal');
      if (!modal) {
        alert(title + '\n\n' + message);
        return;
      }
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      const closeBtn = document.getElementById('modalCloseBtn');
      if (isConfirm) {
        confirmBtn.classList.remove('hidden');
        confirmBtn.onclick = () => { onConfirm(); closeModal(); };
      } else {
        confirmBtn.classList.add('hidden');
      }
      closeBtn.onclick = closeModal;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    // Auth UI bindings
    document.getElementById('btnShowLogin').addEventListener('click', () => {
      document.getElementById('btnShowLogin').classList.add('active');
      document.getElementById('btnShowRegister').classList.remove('active');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
    });
    
    document.getElementById('btnShowRegister').addEventListener('click', () => {
      document.getElementById('btnShowRegister').classList.add('active');
      document.getElementById('btnShowLogin').classList.remove('active');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const authMessage = document.getElementById('authMessage');
      authMessage.textContent = 'Sedang mencoba masuk...';
      
      try {
        console.log('üîê Attempting login...');
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        authMessage.textContent = 'Berhasil masuk. Memuat data...';
        console.log('‚úÖ Login successful');
      } catch (err) {
        console.error('‚ùå Login failed:', err);
        authMessage.textContent = `Gagal masuk: ${err.message}`;
      }
    });

    // Register
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const authMessage = document.getElementById('authMessage');
      
      if (!name) { 
        authMessage.textContent = 'Nama harus diisi.'; 
        return; 
      }
      
      authMessage.textContent = 'Mendaftar...';
      try {
        const { data, error } = await supabase.auth.signUp({ 
          email, 
          password, 
          options: { data: { full_name: name } } 
        });
        if (error) throw error;
        authMessage.textContent = 'Registrasi berhasil. Silakan login dengan email dan password Anda.';
        
        // Reset form
        document.getElementById('registerForm').reset();
        document.getElementById('btnShowLogin').click();
        
      } catch (err) {
        console.error('‚ùå Registration failed:', err);
        authMessage.textContent = `Gagal registrasi: ${err.message}`;
      }
    });

    // Forgot password
    document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) return showModal('Perhatian', 'Masukkan email di kolom email untuk reset password.');
      try {
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, { 
          redirectTo: window.location.href 
        });
        if (error) throw error;
        showModal('Sukses', 'Email reset password telah dikirim (cek inbox/spam).');
      } catch (err) {
        showModal('Gagal', `Gagal mengirim email reset: ${err.message}`);
      }
    });

    // Sign out
    document.getElementById('btnSignOut').addEventListener('click', async () => {
      showModal('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', true, async () => {
        try {
          console.log('üö™ Starting logout process...');
          const { error } = await supabase.auth.signOut();
          if (error) throw error;
          console.log('‚úÖ Logout successful');
          window.location.reload();
        } catch (err) {
          console.error('‚ùå Logout error:', err);
          window.location.reload();
        }
      });
    });

    // Auth state listener dengan comprehensive error handling
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîê Auth state changed:', event);
      
      if (event === 'SIGNED_OUT') {
        console.log('üë§ User signed out');
        user = null;
        userId = null;
        isAuthReady = false;
        showAuthUI();
        
      } else if (event === 'SIGNED_IN' || event === 'USER_UPDATED' || event === 'TOKEN_REFRESHED') {
        user = session?.user ?? null;
        userId = user?.id ?? null;
        isAuthReady = !!userId;
        
        if (userId) {
          console.log('‚úÖ User authenticated:', userId);
          hideAuthUI();
          await postSignInInit();
        } else {
          console.log('‚ùå No user ID found');
          showAuthUI();
        }
      } else if (event === 'INITIAL_SESSION') {
        console.log('üìã Initial session event');
        if (session?.user) {
          user = session.user;
          userId = user.id;
          isAuthReady = true;
          hideAuthUI();
          await postSignInInit();
        } else {
          showAuthUI();
        }
      }
    });

    // Initial session check dengan robust error handling
    (async () => {
      try {
        console.log('üîç Checking initial session...');
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('‚ùå Session check error:', error);
          throw error;
        }
        
        const session = data?.session;
        console.log('üìã Session found:', !!session);
        
        if (session && session.user) {
          user = session.user;
          userId = user.id;
          isAuthReady = true;
          console.log('‚úÖ User session valid:', userId);
          hideAuthUI();
          await postSignInInit();
        } else {
          console.log('‚ÑπÔ∏è No active session, showing auth UI');
          showAuthUI();
        }
      } catch (err) {
        console.error('‚ùå Initial session check failed:', err);
        showModal('Error', 'Gagal memeriksa sesi. Silakan refresh halaman.');
        showAuthUI();
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    })();

    function showAuthUI() {
      console.log('üë§ Showing auth UI');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('authWrapper').classList.remove('hidden');
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function hideAuthUI() {
      console.log('üë§ Hiding auth UI');
      document.getElementById('authWrapper').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    // After sign-in initialization dengan comprehensive error handling
    async function postSignInInit() {
      if (!isAuthReady || !userId) {
        console.log('‚è∏Ô∏è No user ID, skipping init');
        return;
      }
      
      console.log('üöÄ Starting post-sign-in initialization for user:', userId);
      
      try {
        // Update UI first
        document.getElementById('userIdDisplay').textContent = `User: ${user.email}`;
        
        // Test database connection dengan query sederhana
        console.log('üîÑ Testing database connection...');
        const { data: testData, error: testError } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', userId)
          .limit(1);
        
        if (testError) {
          console.error('‚ùå Database connection test failed:', testError);
          if (testError.code === '42P01') {
            throw new Error('Tabel database belum dibuat. Silakan jalankan SQL setup di Supabase.');
          }
          throw new Error(`Database error: ${testError.message} (Code: ${testError.code})`);
        }
        console.log('‚úÖ Database connection successful');
        
        // Lanjutkan dengan initialization normal
        await ensureProfileExists();
        await seedDefaults();
        await fetchAllData();
        renderPage('dashboard');
        
        console.log('‚úÖ App initialization completed successfully');
        
      } catch (error) {
        console.error('‚ùå Post-sign-in initialization failed:', error);
        showModal(
          'Error Initialization', 
          `Gagal memuat aplikasi: ${error.message}\n\nSilakan refresh halaman atau hubungi administrator.`,
          false
        );
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    // Fetch all data in parallel untuk performance
    async function fetchAllData() {
      console.log('üîÑ Fetching all data...');
      try {
        await Promise.all([
          fetchCategories(),
          fetchAccounts(),
          fetchBudgets(),
          fetchTransactions()
        ]);
        console.log('‚úÖ All data fetched successfully');
      } catch (error) {
        console.error('‚ùå Error fetching data:', error);
        throw error;
      }
    }

    async function ensureProfileExists() {
      try {
        console.log('üë§ Ensuring profile exists...');
        const { data: existing, error } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', userId)
          .limit(1)
          .maybeSingle();
        
        if (error) throw error;
        
        if (!existing) {
          console.log('‚ûï Creating new profile...');
          const nameFromMetadata = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'User';
          const { error: insertError } = await supabase
            .from('profiles')
            .insert([{ 
              id: userId, 
              email: user.email, 
              full_name: nameFromMetadata 
            }]);
          
          if (insertError) {
            console.error('‚ùå Profile creation failed:', insertError);
            // Continue anyway, as this might be a permission issue
          } else {
            console.log('‚úÖ Profile created successfully');
          }
        } else {
          console.log('‚úÖ Profile already exists');
        }
      } catch (error) {
        console.error('‚ùå ensureProfileExists failed:', error);
        // Continue anyway, as profile might be created later
      }
    }

    async function seedDefaults() {
      try {
        console.log('üå± Seeding default data...');
        
        // Seed categories jika kosong
        const { data: catData, error: catError } = await supabase
          .from('categories')
          .select('id')
          .eq('profile_id', userId)
          .limit(1);
        
        if (catError) {
          console.warn('‚ö†Ô∏è Could not check categories:', catError);
          return;
        }
        
        if (!catData || catData.length === 0) {
          console.log('‚ûï Seeding default categories...');
          const defaultExpense = ['Makanan & Minuman', 'Transportasi', 'Tagihan', 'Hiburan', 'Belanja'];
          const defaultIncome = ['Gaji', 'Bisnis Sampingan', 'Investasi', 'Bonus'];
          const toInsert = [
            ...defaultExpense.map(name => ({ profile_id: userId, name, type: 'expense' })),
            ...defaultIncome.map(name => ({ profile_id: userId, name, type: 'income' }))
          ];
          
          const { error: insertError } = await supabase.from('categories').insert(toInsert);
          if (insertError) {
            console.warn('‚ö†Ô∏è Could not seed categories:', insertError);
          } else {
            console.log('‚úÖ Default categories seeded');
          }
        }
        
        // Seed accounts jika kosong
        const { data: accData, error: accError } = await supabase
          .from('accounts')
          .select('id')
          .eq('profile_id', userId)
          .limit(1);
        
        if (accError) {
          console.warn('‚ö†Ô∏è Could not check accounts:', accError);
          return;
        }
        
        if (!accData || accData.length === 0) {
          console.log('‚ûï Seeding default accounts...');
          const defaultAccounts = ['Kas', 'Bank Utama', 'E-Wallet', 'Tabungan'];
          const toInsertAcc = defaultAccounts.map(name => ({ profile_id: userId, name }));
          
          const { error: insertError } = await supabase.from('accounts').insert(toInsertAcc);
          if (insertError) {
            console.warn('‚ö†Ô∏è Could not seed accounts:', insertError);
          } else {
            console.log('‚úÖ Default accounts seeded');
          }
        }
        
      } catch (error) {
        console.error('‚ùå seedDefaults failed:', error);
        // Continue anyway, as defaults might not be critical
      }
    }

    // Data fetching functions dengan error handling
    async function fetchCategories() {
      try {
        console.log('üîÑ Fetching categories...');
        const { data, error } = await supabase
          .from('categories')
          .select('*')
          .eq('profile_id', userId)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const rows = data || [];
        currentCategories.expense = rows.filter(r => r.type === 'expense').map(r => r.name);
        currentCategories.incomeSource = rows.filter(r => r.type === 'income').map(r => r.name);
        console.log(`‚úÖ Categories loaded: ${rows.length} items`);
        
      } catch (error) {
        console.error('‚ùå fetchCategories failed:', error);
        throw error;
      }
    }

    async function fetchAccounts() {
      try {
        console.log('üîÑ Fetching accounts...');
        const { data, error } = await supabase
          .from('accounts')
          .select('*')
          .eq('profile_id', userId)
          .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        const rows = data || [];
        currentCategories.account = rows.map(r => r.name);
        console.log(`‚úÖ Accounts loaded: ${rows.length} items`);
        
      } catch (error) {
        console.error('‚ùå fetchAccounts failed:', error);
        throw error;
      }
    }

    async function fetchBudgets() {
      try {
        console.log('üîÑ Fetching budgets...');
        const { data, error } = await supabase
          .from('budgets')
          .select('*')
          .eq('profile_id', userId);
        
        if (error) throw error;
        
        currentBudgets = data || [];
        console.log(`‚úÖ Budgets loaded: ${data?.length || 0} items`);
        
      } catch (error) {
        console.error('‚ùå fetchBudgets failed:', error);
        // Don't throw for budgets, as they might not exist yet
      }
    }

    async function fetchTransactions() {
      try {
        console.log('üîÑ Fetching transactions...');
        const { data, error } = await supabase
          .from('transactions')
          .select('*')
          .eq('profile_id', userId)
          .order('date', { ascending: false });
        
        if (error) throw error;
        
        currentTransactions = data || [];
        console.log(`‚úÖ Transactions loaded: ${data?.length || 0} items`);
        
      } catch (error) {
        console.error('‚ùå fetchTransactions failed:', error);
        throw error;
      }
    }

    // CRUD operations dengan comprehensive error handling
    async function addCategory(type, name) {
      if (!name) return showModal('Perhatian', 'Nama kategori tidak boleh kosong.');
      if (!isAuthReady || !userId) {
        return showModal('Error', 'User tidak terautentikasi. Silakan login ulang.');
      }
      
      try {
        console.log('‚ûï Adding category:', { type, name });
        
        const { data, error } = await supabase
          .from('categories')
          .insert([{ 
            profile_id: userId, 
            name: name.trim(), 
            type: type 
          }])
          .select();
        
        if (error) {
          console.error('‚ùå Supabase error:', error);
          if (error.code === '42501') {
            throw new Error('Permission denied. Pastikan RLS policies sudah di-setup di Supabase.');
          } else if (error.code === '23505') {
            throw new Error('Kategori dengan nama tersebut sudah ada.');
          } else {
            throw error;
          }
        }
        
        await fetchCategories();
        showModal('Sukses', `Kategori "${name}" berhasil ditambahkan.`);
        
      } catch (err) {
        console.error('‚ùå addCategory error:', err);
        showModal('Gagal', `Gagal menambah kategori: ${err.message}`);
      }
    }

    async function deleteCategory(name) {
      try {
        const { error } = await supabase
          .from('categories')
          .delete()
          .eq('profile_id', userId)
          .eq('name', name);
        
        if (error) throw error;
        await fetchCategories();
        showModal('Sukses', `Kategori "${name}" berhasil dihapus.`);
      } catch (err) {
        console.error('‚ùå deleteCategory error:', err);
        showModal('Gagal', `Gagal menghapus kategori: ${err.message}`);
      }
    }

    async function addAccount(name) {
      if (!name) return showModal('Perhatian', 'Nama akun tidak boleh kosong.');
      if (!isAuthReady || !userId) {
        return showModal('Error', 'User tidak terautentikasi. Silakan login ulang.');
      }
      
      try {
        console.log('‚ûï Adding account:', { name });
        
        const { data, error } = await supabase
          .from('accounts')
          .insert([{ 
            profile_id: userId, 
            name: name.trim() 
          }])
          .select();
        
        if (error) {
          console.error('‚ùå Supabase error:', error);
          if (error.code === '42501') {
            throw new Error('Permission denied. Pastikan RLS policies sudah di-setup di Supabase.');
          } else if (error.code === '23505') {
            throw new Error('Akun dengan nama tersebut sudah ada.');
          } else {
            throw error;
          }
        }
        
        await fetchAccounts();
        showModal('Sukses', `Akun "${name}" berhasil ditambahkan.`);
        
      } catch (err) {
        console.error('‚ùå addAccount error:', err);
        showModal('Gagal', `Gagal menambah akun: ${err.message}`);
      }
    }

    async function deleteAccount(name) {
      try {
        const { error } = await supabase
          .from('accounts')
          .delete()
          .eq('profile_id', userId)
          .eq('name', name);
        
        if (error) throw error;
        await fetchAccounts();
        showModal('Sukses', `Akun "${name}" berhasil dihapus.`);
      } catch (err) {
        console.error('‚ùå deleteAccount error:', err);
        showModal('Gagal', `Gagal menghapus akun: ${err.message}`);
      }
    }

    // Transaction operations
    async function saveTransactionResolved(type, amount, dateStr, categoryName, accountName, description) {
      if (!isAuthReady || !userId) return;
      
      try {
        let category_id = null;
        if (categoryName) {
          const { data: cat } = await supabase
            .from('categories')
            .select('id')
            .eq('profile_id', userId)
            .eq('name', categoryName)
            .limit(1)
            .maybeSingle();
          if (cat && cat.id) category_id = cat.id;
        }
        
        let account_id = null;
        if (accountName) {
          const { data: acc } = await supabase
            .from('accounts')
            .select('id')
            .eq('profile_id', userId)
            .eq('name', accountName)
            .limit(1)
            .maybeSingle();
          if (acc && acc.id) account_id = acc.id;
        }

        const payload = {
          profile_id: userId,
          account_id,
          category_id,
          account_name: accountName || null,
          category_name: categoryName || null,
          type,
          amount: parseFloat(amount),
          date: dateStr,
          period: dateStr.substring(0,7),
          description: description || ''
        };

        const { error } = await supabase.from('transactions').insert([payload]);
        if (error) throw error;
        
        await fetchTransactions();
        showModal('Sukses', `${type} baru berhasil ditambahkan!`);
        document.getElementById('transactionForm')?.reset();
      } catch (err) {
        console.error('‚ùå saveTransactionResolved error:', err);
        showModal('Gagal', `Gagal menambahkan transaksi: ${err.message}`);
      }
    }

    async function deleteTransaction(txId) {
      if (!isAuthReady || !userId) return;
      try {
        const { error } = await supabase
          .from('transactions')
          .delete()
          .eq('id', txId)
          .eq('profile_id', userId);
        
        if (error) throw error;
        await fetchTransactions();
        showModal('Sukses', 'Transaksi berhasil dihapus.');
      } catch (err) {
        console.error('‚ùå deleteTransaction error:', err);
        showModal('Gagal', `Gagal menghapus transaksi: ${err.message}`);
      }
    }

    // Budget operations
    async function saveBudgetForPeriod(period, budgetsObj) {
      try {
        for (const categoryName of Object.keys(budgetsObj)) {
          const amount = budgetsObj[categoryName];
          const { data: cat } = await supabase
            .from('categories')
            .select('id')
            .eq('profile_id', userId)
            .eq('name', categoryName)
            .limit(1)
            .maybeSingle();
          
          const category_id = cat?.id ?? null;
          const payload = {
            profile_id: userId,
            category_id,
            period,
            amount_limit: amount
          };
          
          const { error } = await supabase
            .from('budgets')
            .upsert(payload, { onConflict: ['profile_id','category_id','period'] });
          
          if (error) throw error;
        }
        
        await fetchBudgets();
        showModal('Sukses', 'Budget berhasil disimpan.');
      } catch (err) {
        console.error('‚ùå saveBudgetForPeriod error:', err);
        showModal('Gagal', `Gagal menyimpan budget: ${err.message}`);
      }
    }

    // UI rendering functions
    function renderPage(pageName) {
      console.log(`üìÑ Rendering page: ${pageName}`);
      currentPage = pageName;
      const container = document.getElementById('pageContainer');
      const navButtons = document.querySelectorAll('.nav-link');

      navButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-page') === pageName) btn.classList.add('active');
      });

      switch (pageName) {
        case 'dashboard':
          container.innerHTML = renderDashboardPageTemplate();
          loadDashboard(currentPeriod);
          break;
        case 'transaksi':
          container.innerHTML = renderTransactionPageTemplate();
          setupTransactionForm();
          renderTransactionsList();
          break;
        case 'budget':
          container.innerHTML = renderBudgetPageTemplate();
          renderBudgetPage();
          break;
        case 'pengaturan':
          container.innerHTML = renderSettingsPageTemplate();
          renderSettingsPage();
          break;
        default:
          container.innerHTML = `<div class="p-6 text-center text-red-500">Halaman tidak ditemukan.</div>`;
      }

      if (pageName === 'dashboard') {
        const prevBtn = document.getElementById('prevPeriod');
        const nextBtn = document.getElementById('nextPeriod');
        if (prevBtn) prevBtn.addEventListener('click', () => changePeriod(-1));
        if (nextBtn) nextBtn.addEventListener('click', () => changePeriod(1));
      }
    }

    // Template functions
    function renderDashboardPageTemplate() {
      return `
        <div class="space-y-6">
          <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-3 sm:space-y-0 sm:space-x-3">
            <h2 id="currentPeriodDisplay" class="text-xl font-bold">Periode: ${formatPeriod(currentPeriod)}</h2>
            <div class="flex space-x-2 w-full sm:w-auto">
              <button id="prevPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                &larr; Sebelumnya
              </button>
              <button id="nextPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                Berikutnya &rarr;
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid ${incomeColor};">
              <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pemasukan</h3>
              <p id="totalIncome" class="text-2xl font-extrabold" style="color: ${incomeColor};">Rp -</p>
            </div>
            <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid ${expenseColor};">
              <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pengeluaran</h3>
              <p id="totalExpense" class="text-2xl font-extrabold" style="color: ${expenseColor};">Rp -</p>
            </div>
            <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid ${balanceColor};">
              <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Saldo Bersih</h3>
              <p id="netBalance" class="text-2xl font-extrabold" style="color: ${balanceColor};">Rp -</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="card p-4 rounded-xl lg:col-span-1">
              <h3 class="text-lg font-bold mb-2">Status Budget Pengeluaran (${formatPeriod(currentPeriod)})</h3>
              <div id="budgetStatusContainer">
                <div class="text-center p-4 text-gray-500">
                  <p>Fitur budget akan segera hadir</p>
                </div>
              </div>
            </div>

            <div class="card p-4 rounded-xl lg:col-span-2 order-last lg:order-none">
              <h3 class="text-xl font-bold mb-2">Statistik Aplikasi</h3>
              <div class="space-y-4 p-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Total Transaksi:</span>
                  <span class="font-bold">${currentTransactions.length}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Kategori Pengeluaran:</span>
                  <span class="font-bold">${currentCategories.expense.length}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Sumber Pemasukan:</span>
                  <span class="font-bold">${currentCategories.incomeSource.length}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Akun/Dompet:</span>
                  <span class="font-bold">${currentCategories.account.length}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-4 rounded-xl">
              <h3 class="text-lg font-bold mb-2">5 Transaksi Terbaru</h3>
              <div id="recentTransactions" class="space-y-2">
                ${renderRecentTransactions()}
              </div>
            </div>
            <div class="card p-4 rounded-xl">
              <h3 class="text-lg font-bold mb-2">Quick Actions</h3>
              <div class="space-y-3">
                <button onclick="renderPage('transaksi')" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">
                  + Tambah Transaksi
                </button>
                <button onclick="renderPage('pengaturan')" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600">
                  ‚öôÔ∏è Pengaturan
                </button>
                <button onclick="window.debugApp()" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600">
                  üêõ Debug Info
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderRecentTransactions() {
      const recent = currentTransactions.slice(0, 5);
      if (recent.length === 0) {
        return '<p class="text-gray-500 text-center p-4">Belum ada transaksi</p>';
      }
      
      return recent.map(tx => {
        const isExpense = tx.type === 'Pengeluaran';
        const color = isExpense ? expenseColor : incomeColor;
        const sign = isExpense ? '-' : '+';
        return `
          <div class="flex justify-between items-center p-2 border-b">
            <div class="flex-grow">
              <p class="font-semibold text-sm">${tx.description || tx.category_name || 'Transaksi'}</p>
              <p class="text-xs text-gray-500">${tx.date} ‚Ä¢ ${tx.category_name || '-'}</p>
            </div>
            <p class="font-bold text-sm" style="color: ${color};">${sign} ${formatRupiah(tx.amount).replace('Rp','')}</p>
          </div>
        `;
      }).join('');
    }

    function renderTransactionPageTemplate() {
      const today = new Date().toISOString().substring(0,10);
      const expenseOptions = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      const incomeSourceOptions = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      const accountOptions = currentCategories.account.map(acc => `<option value="${acc}">${acc}</option>`).join('');
      
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4">Tambah Transaksi Baru</h2>
            <form id="transactionForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Tipe Transaksi</label>
                <select id="txType" name="type" required class="w-full p-2 border border-gray-300 rounded-lg">
                  <option value="Pengeluaran">Pengeluaran</option>
                  <option value="Pemasukan">Pemasukan</option>
                </select>
              </div>
              <div>
                <label for="txAmount" class="block text-sm font-medium mb-1">Jumlah (Rp)</label>
                <input type="number" id="txAmount" name="amount" required min="1" class="w-full p-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label for="txDate" class="block text-sm font-medium mb-1">Tanggal</label>
                <input type="date" id="txDate" name="date" value="${today}" required class="w-full p-2 border border-gray-300 rounded-lg">
              </div>

              <div id="categoryContainer">
                <label for="txCategory" class="block text-sm font-medium mb-1" id="categoryLabel">Kategori Pengeluaran</label>
                <select id="txCategory" name="category" required class="w-full p-2 border border-gray-300 rounded-lg">
                  ${expenseOptions || '<option value="">Belum ada kategori</option>'}
                </select>
              </div>

              <div>
                <label for="txAccount" class="block text-sm font-medium mb-1">Akun / Dompet</label>
                <select id="txAccount" name="account" required class="w-full p-2 border border-gray-300 rounded-lg">
                  ${accountOptions || '<option value="">Belum ada akun</option>'}
                </select>
              </div>

              <div>
                <label for="txDescription" class="block text-sm font-medium mb-1">Deskripsi (Opsional)</label>
                <input type="text" id="txDescription" name="description" class="w-full p-2 border border-gray-300 rounded-lg">
              </div>

              <button type="submit" class="btn-primary w-full text-white font-semibold py-2 rounded-lg mt-2">Simpan Transaksi</button>
            </form>
          </div>

          <div class="lg:col-span-2 card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4">Daftar Semua Transaksi</h2>
            <div id="transactionsList" class="space-y-3 max-h-[70vh] overflow-y-auto">
              <p class="text-gray-500 text-center p-4">Memuat transaksi...</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderBudgetPageTemplate() {
      return `
        <div class="card p-6 rounded-xl">
          <h2 class="text-2xl font-bold mb-4">Manajemen Budget</h2>
          <div class="text-center p-8">
            <div class="text-gray-400 text-6xl mb-4">üí∞</div>
            <h3 class="text-xl font-semibold mb-2">Fitur Segera Hadir</h3>
            <p class="text-gray-600 mb-4">Fitur manajemen budget sedang dalam pengembangan.</p>
            <button onclick="renderPage('dashboard')" class="btn-primary text-white px-4 py-2 rounded-lg">Kembali ke Dashboard</button>
          </div>
        </div>
      `;
    }

    function renderSettingsPageTemplate() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-bold mb-4">Pengaturan Kategori & Akun</h2>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${expenseColor};">Kategori Pengeluaran</h3>
              <div id="expenseCategoryList" class="mb-4 space-y-2 max-h-40 overflow-y-auto">
                ${currentCategories.expense.map(cat => `
                  <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                    <span>${cat}</span>
                    <button data-name="${cat}" data-type="expense" class="delete-cat-btn text-red-500 hover:text-red-700 text-sm">Hapus</button>
                  </div>
                `).join('')}
                ${currentCategories.expense.length === 0 ? '<p class="text-gray-500 text-center p-2">Belum ada kategori</p>' : ''}
              </div>
              <form id="addExpenseCategoryForm" class="flex space-x-2">
                <input type="text" id="newExpenseCategory" placeholder
                                <input type="text" id="newExpenseCategory" placeholder="Nama Kategori Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${incomeColor};">Sumber Pemasukan</h3>
              <div id="incomeSourceList" class="mb-4 space-y-2 max-h-40 overflow-y-auto">
                ${currentCategories.incomeSource.map(cat => `
                  <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                    <span>${cat}</span>
                    <button data-name="${cat}" data-type="income" class="delete-cat-btn text-red-500 hover:text-red-700 text-sm">Hapus</button>
                  </div>
                `).join('')}
                ${currentCategories.incomeSource.length === 0 ? '<p class="text-gray-500 text-center p-2">Belum ada sumber pemasukan</p>' : ''}
              </div>
              <form id="addIncomeSourceForm" class="flex space-x-2">
                <input type="text" id="newIncomeSource" placeholder="Nama Sumber Pemasukan Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${balanceColor};">Akun / Dompet</h3>
              <div id="accountList" class="mb-4 space-y-2 max-h-40 overflow-y-auto">
                ${currentCategories.account.map(acc => `
                  <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm">
                    <span>${acc}</span>
                    <button data-name="${acc}" data-type="account" class="delete-cat-btn text-red-500 hover:text-red-700 text-sm">Hapus</button>
                  </div>
                `).join('')}
                ${currentCategories.account.length === 0 ? '<p class="text-gray-500 text-center p-2">Belum ada akun</p>' : ''}
              </div>
              <form id="addAccountForm" class="flex space-x-2">
                <input type="text" id="newAccount" placeholder="Nama Akun/Dompet Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
            </div>
          </div>

          <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-bold mb-4">Pengaturan & Tools</h2>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3">Debug & Testing</h3>
              <div class="space-y-3">
                <button onclick="window.testAddCategory()" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-green-600">
                  Test Tambah Kategori
                </button>
                <button onclick="window.testAddAccount()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-600">
                  Test Tambah Akun
                </button>
                <button onclick="window.debugApp()" class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-gray-600">
                  Show Debug Info
                </button>
              </div>
              <div id="testResults" class="mt-3 p-3 bg-white rounded border hidden"></div>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3">Status Aplikasi</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>User ID:</span>
                  <span class="font-mono">${userId ? userId.substring(0, 8) + '...' : 'Not logged in'}</span>
                </div>
                <div class="flex justify-between">
                  <span>Transaksi:</span>
                  <span>${currentTransactions.length} items</span>
                </div>
                <div class="flex justify-between">
                  <span>Kategori:</span>
                  <span>${currentCategories.expense.length + currentCategories.incomeSource.length} items</span>
                </div>
                <div class="flex justify-between">
                  <span>Akun:</span>
                  <span>${currentCategories.account.length} items</span>
                </div>
              </div>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3">Reset Data</h3>
              <p class="text-sm text-gray-600 mb-3">Hati-hati! Tindakan ini tidak dapat dibatalkan.</p>
              <button onclick="showModal('Reset Data', 'Yakin ingin menghapus semua data transaksi?', true, () => resetAllTransactions())" 
                      class="w-full bg-red-500 text-white py-2 px-4 rounded-lg text-sm hover:bg-red-600">
                Hapus Semua Transaksi
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // UI helper functions
    function setupTransactionForm() {
      const form = document.getElementById('transactionForm');
      if (!form) return;
      
      const txTypeSelect = document.getElementById('txType');
      const txCategorySelect = document.getElementById('txCategory');
      const categoryLabel = document.getElementById('categoryLabel');

      function updateCategoryOptions() {
        const type = txTypeSelect.value;
        let options = '';
        if (type === 'Pengeluaran') {
          options = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          categoryLabel.textContent = 'Kategori Pengeluaran';
        } else {
          options = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          categoryLabel.textContent = 'Sumber Pemasukan';
        }
        txCategorySelect.innerHTML = options || '<option value="">Belum ada kategori</option>';
      }

      txTypeSelect.addEventListener('change', updateCategoryOptions);
      updateCategoryOptions();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = form.elements['type'].value;
        const amount = form.elements['amount'].value;
        const date = form.elements['date'].value;
        const category = form.elements['category'].value;
        const account = form.elements['account'].value;
        const description = form.elements['description'].value;
        
        if (!category) return showModal('Gagal', 'Kategori/Sumber harus dipilih.');
        if (!account) return showModal('Gagal', 'Akun/Dompet harus dipilih.');

        await saveTransactionResolved(type, amount, date, category, account, description);
      });
    }

    function renderTransactionsList() {
      const container = document.getElementById('transactionsList');
      if (!container) return;

      if (currentTransactions.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center p-4">Belum ada transaksi. Tambahkan transaksi pertama Anda!</p>';
        return;
      }

      const transactionsHtml = currentTransactions.map(tx => {
        const isExpense = tx.type === 'Pengeluaran';
        const color = isExpense ? expenseColor : incomeColor;
        const sign = isExpense ? '-' : '+';
        return `
          <div class="flex justify-between items-center p-3 rounded-lg card transition hover:shadow-md">
            <div class="flex-grow">
              <p class="font-semibold text-sm" style="color: ${color};">${tx.description || tx.category_name || tx.category || 'Transaksi'}</p>
              <p class="text-xs text-gray-500">${tx.date} | ${tx.category_name || tx.category || '-'} | Akun: ${tx.account_name || tx.account || '-'}</p>
            </div>
            <div class="flex items-center space-x-3">
              <p class="font-bold text-sm ml-2" style="color: ${color};">${sign} ${formatRupiah(tx.amount).replace('Rp','')}</p>
              <button data-id="${tx.id}" class="delete-tx-btn text-red-400 hover:text-red-600 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = transactionsHtml;

      // Add event listeners to delete buttons
      container.querySelectorAll('.delete-tx-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const txId = e.currentTarget.getAttribute('data-id');
          showModal('Konfirmasi Hapus', 'Anda yakin ingin menghapus transaksi ini?', true, () => deleteTransaction(txId));
        });
      });
    }

    function renderSettingsPage() {
      // Add event listeners for forms
      document.getElementById('addExpenseCategoryForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newExpenseCategory');
        addCategory('expense', input.value.trim());
        input.value = '';
      });
      
      document.getElementById('addIncomeSourceForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newIncomeSource');
        addCategory('income', input.value.trim());
        input.value = '';
      });
      
      document.getElementById('addAccountForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newAccount');
        addAccount(input.value.trim());
        input.value = '';
      });

      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-cat-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const name = e.currentTarget.getAttribute('data-name');
          const type = e.currentTarget.getAttribute('data-type');
          showModal('Konfirmasi Hapus', `Yakin ingin menghapus "${name}"?`, true, () => {
            if (type === 'account') deleteAccount(name);
            else deleteCategory(name);
          });
        });
      });
    }

    function loadDashboard(period) {
      currentPeriod = period || currentPeriod;
      const displayEl = document.getElementById('currentPeriodDisplay');
      if (displayEl) displayEl.textContent = `Periode: ${formatPeriod(currentPeriod)}`;

      const filteredTx = currentTransactions.filter(tx => tx.period === currentPeriod);

      let totalIncome = 0;
      let totalExpense = 0;

      filteredTx.forEach(tx => {
        const amount = Number(tx.amount) || 0;
        if (tx.type === 'Pemasukan') totalIncome += amount;
        else if (tx.type === 'Pengeluaran') totalExpense += amount;
      });

      const netBalance = totalIncome - totalExpense;
      const totalIncomeEl = document.getElementById('totalIncome');
      const totalExpenseEl = document.getElementById('totalExpense');
      const netBalanceEl = document.getElementById('netBalance');
      
      if (totalIncomeEl) totalIncomeEl.textContent = formatRupiah(totalIncome);
      if (totalExpenseEl) totalExpenseEl.textContent = formatRupiah(totalExpense);
      if (netBalanceEl) {
        netBalanceEl.textContent = formatRupiah(netBalance);
        netBalanceEl.style.color = netBalance >= 0 ? incomeColor : expenseColor;
      }
    }

    function renderBudgetPage() {
      // Simple budget page for now
      console.log('Rendering budget page');
    }

    function formatPeriod(period) {
      if (!period) return 'N/A';
      const [year, month] = period.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
    }

    function changePeriod(offset) {
      const [year, month] = currentPeriod.split('-').map(Number);
      const date = new Date(year, month - 1);
      date.setMonth(date.getMonth() + offset);
      const newYear = date.getFullYear();
      const newMonth = String(date.getMonth() + 1).padStart(2, '0');
      currentPeriod = `${newYear}-${newMonth}`;
      
      if (currentPage === 'dashboard') loadDashboard(currentPeriod);
    }

    // Test functions
    window.testAddCategory = async function() {
      const results = document.getElementById('testResults');
      if (results) {
        results.classList.remove('hidden');
        results.innerHTML = '<p class="text-blue-500">üîÑ Menambah kategori test...</p>';
      }
      
      try {
        await addCategory('expense', 'Test Category ' + Date.now());
        if (results) {
          results.innerHTML = '<p class="text-green-500">‚úÖ Kategori berhasil ditambah!</p>';
        }
      } catch (error) {
        if (results) {
          results.innerHTML = `<p class="text-red-500">‚ùå Gagal: ${error.message}</p>`;
        }
      }
    };

    window.testAddAccount = async function() {
      const results = document.getElementById('testResults');
      if (results) {
        results.classList.remove('hidden');
        results.innerHTML = '<p class="text-blue-500">üîÑ Menambah akun test...</p>';
      }
      
      try {
        await addAccount('Test Account ' + Date.now());
        if (results) {
          results.innerHTML = '<p class="text-green-500">‚úÖ Akun berhasil ditambah!</p>';
        }
      } catch (error) {
        if (results) {
          results.innerHTML = `<p class="text-red-500">‚ùå Gagal: ${error.message}</p>`;
        }
      }
    };

    // Reset function
    async function resetAllTransactions() {
      try {
        const { error } = await supabase
          .from('transactions')
          .delete()
          .eq('profile_id', userId);
        
        if (error) throw error;
        await fetchTransactions();
        showModal('Sukses', 'Semua transaksi berhasil dihapus.');
      } catch (err) {
        console.error('‚ùå resetAllTransactions error:', err);
        showModal('Gagal', `Gagal menghapus transaksi: ${err.message}`);
      }
    }

    // Debug function
    window.debugApp = function() {
      console.log('=== DEBUG INFO ===');
      console.log('User:', user);
      console.log('User ID:', userId);
      console.log('Is Auth Ready:', isAuthReady);
      console.log('Current Page:', currentPage);
      console.log('Current Period:', currentPeriod);
      console.log('Transactions:', currentTransactions);
      console.log('Categories:', currentCategories);
      console.log('Accounts:', currentCategories.account);
      console.log('Budgets:', currentBudgets);
      
      showModal(
        'Debug Information', 
        `User: ${user?.email}\nUser ID: ${userId}\nTransactions: ${currentTransactions.length}\nCategories: ${currentCategories.expense.length + currentCategories.incomeSource.length}\nAccounts: ${currentCategories.account.length}`,
        false
      );
    };

    // Navigation
    document.querySelectorAll('.nav-link').forEach(button => {
      button.addEventListener('click', (e) => {
        renderPage(e.target.getAttribute('data-page'));
      });
    });

    console.log('‚úÖ Budgetin application initialized successfully');

  </script>
</body>
</html>
