<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Budgetin</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Charts CDN -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <style>
    /* ---------------------------------------------------------------------- */
    /* 1. DEFINISI TEMA (Menggunakan Tema Hijau Soft Default) */
    /* ---------------------------------------------------------------------- */
    
    :root {
      /* Warna Dasar Tema Hijau-Putih (Light Soft Theme) */
      --color-white-bg: #FFFFFF;
      --color-light-bg: #FAF9F6;
      --color-dark-text: #333333;
      --color-green-primary: #7CD18B;
      --color-red-expense: #F0939A;
      --color-border-classic: #E0E0E0;
      --color-balance-blue: #8AB8DE;
      --color-header-green: #6AA573;

      /* Mapping ke Variabel Aplikasi */
      --bg-color: var(--color-light-bg);
      --card-bg: var(--color-white-bg);
      --text-color: var(--color-dark-text);
      --income-color: var(--color-green-primary);
      --expense-color: var(--color-red-expense);
      --balance-color: var(--color-balance-blue);
      --primary-accent: var(--color-header-green);
      --chart-bg: var(--color-white-bg);
      --chart-text: var(--color-dark-text);
      
      /* Font Family */
      --font-family-sans: 'Inter', sans-serif;
    }

    /* ---------------------------------------------------------------------- */
    /* 2. BASE STYLING & UTILITIES */
    /* ---------------------------------------------------------------------- */
    
    body {
      font-family: var(--font-family-sans);
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    /* Global Card Style */
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--color-border-classic);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }

    /* Button Styling */
    .btn-primary {
      background-color: var(--primary-accent);
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background-color: #5a8a61; /* sedikit lebih gelap */
    }

    /* Custom Loading Spinner (agar terlihat profesional) */
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Styling untuk tombol Navigasi Period (Agar terlihat lebih baik di mobile) */
    .period-button {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Styling untuk Navigasi Menu */
    .nav-link {
        padding: 0.75rem 1.25rem;
        transition: all 0.2s;
        border-radius: 0.5rem;
        font-weight: 600;
        text-align: center;
    }
    .nav-link.active {
        background-color: var(--primary-accent);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .nav-link:not(.active):hover {
        background-color: #e5e7eb;
    }

    /* Simple auth container */
    #authContainer {
      max-width: 520px;
      margin: 3rem auto;
    }
  </style>
</head>

<body class="min-h-screen p-2 sm:p-4 md:p-6">
  <!-- Loading Overlay Awal -->
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center transition-opacity duration-300">
    <div class="spinner"></div>
    <p class="ml-4 text-lg font-semibold text-gray-700">Memuat Aplikasi...</p>
  </div>

  <!-- AUTH (Login/Register) -->
  <div id="authWrapper" class="hidden">
    <div id="authContainer" class="bg-white p-6 rounded-xl shadow-lg">
      <h1 class="text-3xl font-extrabold mb-2" style="color: var(--primary-accent);">Budgetin</h1>
      <p class="text-sm text-gray-600 mb-4">Lacak aliran uangmu. Masuk dengan email & password.</p>

      <div class="mb-4">
        <div class="flex gap-2">
          <button id="btnShowLogin" class="nav-link active">Login</button>
          <button id="btnShowRegister" class="nav-link">Register</button>
        </div>
      </div>

      <div id="authForms">
        <!-- Login Form -->
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="loginEmail" type="email" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input id="loginPassword" type="password" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="flex justify-between items-center">
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Masuk</button>
            <a href="#" id="forgotPasswordLink" class="text-sm text-gray-600 underline">Lupa password?</a>
          </div>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="space-y-3 hidden">
          <div>
            <label class="block text-sm font-medium mb-1">Nama Lengkap</label>
            <input id="regName" type="text" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="regEmail" type="email" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Password</label>
            <input id="regPassword" type="password" required class="w-full p-2 border border-gray-300 rounded-lg" />
          </div>
          <div class="flex justify-end">
            <button type="submit" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Daftar</button>
          </div>
        </form>
      </div>

      <div id="authMessage" class="mt-4 text-sm text-gray-600"></div>
    </div>
  </div>

  <!-- Konten Utama Aplikasi -->
  <div id="mainContent" class="hidden max-w-7xl mx-auto">
    
    <!-- Header dan Navigasi -->
    <header class="mb-6 p-4 rounded-xl bg-white shadow-lg">
      <!-- Judul dan User ID -->
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
        <h1 class="text-3xl font-extrabold" style="color: var(--primary-accent);">Budgetin</h1>
        <div class="flex items-center gap-3">
          <p id="userIdDisplay" class="text-xs mt-2 sm:mt-0 p-1 bg-gray-100 rounded-full inline-block text-gray-600"></p>
          <button id="btnSignOut" class="text-sm text-red-500 hover:text-red-700">Logout</button>
        </div>
      </div>

      <!-- Menu Navigasi (Tabs) -->
      <nav class="flex flex-wrap justify-center sm:justify-start gap-2">
        <button class="nav-link active" data-page="dashboard">Dashboard</button>
        <button class="nav-link" data-page="transaksi">Transaksi</button>
        <button class="nav-link" data-page="budget">Budget</button>
        <button class="nav-link" data-page="pengaturan">Pengaturan</button>
      </nav>
    </header>

    <!-- Konten Halaman (Dynamic Content) -->
    <div id="pageContainer">
      <!-- Konten spesifik halaman akan di-render di sini -->
    </div>
    
  </div>

  <!-- Modal untuk notifikasi (Ganti alert/confirm) -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center p-4" onclick="closeModal()">
    <div class="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl" onclick="event.stopPropagation()">
      <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">Notifikasi</h3>
      <p id="modalMessage" class="text-gray-600 mb-4"></p>
      <div class="flex justify-end space-x-3">
        <button id="modalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hidden">Konfirmasi</button>
        <button id="modalCloseBtn" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Tutup</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT: Supabase integration and app logic -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // Supabase credentials (you provided these)
    const SUPABASE_URL = 'https://xzlggtyvgnyzzofgudwa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6bGdndHl2Z255enpvZmd1ZHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MDk0MjcsImV4cCI6MjA3NzQ4NTQyN30.x77c3j7TfL5_tQStYNSurhEC6gUDIasuVUk8YpJAi5E';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true } });

    // App state
    let user = null;
    let userId = null;
    let isAuthReady = false;

    let currentTransactions = [];
    let currentBudgets = [];
    let currentCategories = { expense: [], incomeSource: [], account: [] };

    let currentPage = 'dashboard';
    let currentPeriod = new Date().toISOString().substring(0,7); // YYYY-MM

    // Realtime subscriptions - FIXED
    let realtimeChannel = null;

    // Colors from CSS
    const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--color-red-expense').trim();
    const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-green-primary').trim();
    const balanceColor = getComputedStyle(document.documentElement).getPropertyValue('--color-balance-blue').trim();
    const chartBg = getComputedStyle(document.documentElement).getPropertyValue('--chart-bg').trim();
    const chartText = getComputedStyle(document.documentElement).getPropertyValue('--chart-text') || getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
    const primaryAccent = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent').trim();

    // Utility: format currency (IDR)
    function formatRupiah(number) {
      if (number === null || number === undefined || isNaN(number)) return 'Rp -';
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(number);
    }

    // Modal helpers
    function showModal(title, message, isConfirm = false, onConfirm = () => {}) {
      const modal = document.getElementById('modal');
      if (!modal) {
        alert(title + '\n\n' + message);
        return;
      }
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const confirmBtn = document.getElementById('modalConfirmBtn');
      const closeBtn = document.getElementById('modalCloseBtn');
      if (isConfirm) {
        confirmBtn.classList.remove('hidden');
        confirmBtn.onclick = () => { onConfirm(); closeModal(); };
      } else {
        confirmBtn.classList.add('hidden');
      }
      closeBtn.onclick = closeModal;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }

    // Auth UI bindings
    const authWrapper = document.getElementById('authWrapper');
    const authMessage = document.getElementById('authMessage');

    document.getElementById('btnShowLogin').addEventListener('click', () => {
      document.getElementById('btnShowLogin').classList.add('active');
      document.getElementById('btnShowRegister').classList.remove('active');
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('registerForm').classList.add('hidden');
    });
    document.getElementById('btnShowRegister').addEventListener('click', () => {
      document.getElementById('btnShowRegister').classList.add('active');
      document.getElementById('btnShowLogin').classList.remove('active');
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('loginForm').classList.add('hidden');
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      authMessage.textContent = 'Sedang mencoba masuk...';
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        authMessage.textContent = 'Berhasil masuk. Memuat data...';
      } catch (err) {
        authMessage.textContent = `Gagal masuk: ${err.message || err}`;
      }
    });

    // Register
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      if (!name) { authMessage.textContent = 'Nama harus diisi.'; return; }
      authMessage.textContent = 'Mendaftar...';
      try {
        const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: name } } });
        if (error) throw error;
        authMessage.textContent = 'Registrasi berhasil. Jika perlu, cek email untuk mengonfirmasi.';
        try {
          const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({ email, password });
        } catch (e) {
        }
      } catch (err) {
        authMessage.textContent = `Gagal registrasi: ${err.message || err}`;
      }
    });

    // Forgot password
    document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) return showModal('Perhatian', 'Masukkan email di kolom email untuk reset password.');
      try {
        const { data, error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
        if (error) throw error;
        showModal('Sukses', 'Email reset password telah dikirim (cek inbox/spam).');
      } catch (err) {
        showModal('Gagal', `Gagal mengirim email reset: ${err.message || err}`);
      }
    });

    // Cleanup function - FIXED
    function cleanupRealtime() {
      if (realtimeChannel) {
        console.log('Cleaning up realtime channel');
        supabase.removeChannel(realtimeChannel);
        realtimeChannel = null;
      }
    }

    function setupRealtime() {
      try {
        // Hentikan channel yang existing
        cleanupRealtime();
        
        if (!userId) {
          console.log('No user ID, skipping realtime setup');
          return;
        }
        
        console.log('Setting up realtime for user:', userId);
        realtimeChannel = supabase.channel('realtime-' + userId)
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'transactions', 
              filter: `profile_id=eq.${userId}` 
            }, 
            () => {
              console.log('Transaction changed, refetching...');
              fetchTransactions();
            }
          )
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'categories', 
              filter: `profile_id=eq.${userId}` 
            }, 
            () => {
              console.log('Categories changed, refetching...');
              fetchCategories();
            }
          )
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'accounts', 
              filter: `profile_id=eq.${userId}` 
            }, 
            () => {
              console.log('Accounts changed, refetching...');
              fetchAccounts();
            }
          )
          .on('postgres_changes', 
            { 
              event: '*', 
              schema: 'public', 
              table: 'budgets', 
              filter: `profile_id=eq.${userId}` 
            }, 
            () => {
              console.log('Budgets changed, refetching...');
              fetchBudgets();
            }
          )
          .on('system', { event: 'disconnect' }, () => {
            console.log('Realtime disconnected');
          })
          .subscribe((status) => {
            console.log('Realtime subscription status:', status);
          });
        
      } catch (err) {
        console.warn('setupRealtime error', err);
      }
    }

    // Sign out - FIXED VERSION
    document.getElementById('btnSignOut').addEventListener('click', async () => {
      showModal('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', true, async () => {
        try {
          console.log('Starting logout process...');
          
          // 1. Cleanup realtime first
          cleanupRealtime();
          
          // 2. Clear all app state
          user = null;
          userId = null;
          isAuthReady = false;
          currentTransactions = [];
          currentBudgets = [];
          currentCategories = { expense: [], incomeSource: [], account: [] };
          
          // 3. Sign out from Supabase
          const { error } = await supabase.auth.signOut();
          if (error) {
            console.error('Supabase signOut error:', error);
            throw error;
          }
          
          console.log('Logout successful, reloading page...');
          
          // 4. Force reload to ensure clean state
          setTimeout(() => {
            window.location.reload();
          }, 500);
          
        } catch (err) {
          console.error('Logout error:', err);
          // Fallback: force reload anyway
          window.location.reload();
        }
      });
    });

    // Auth state listener - FIXED
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth state changed:', event, 'User:', session?.user?.id);
      
      if (event === 'SIGNED_OUT') {
        console.log('User signed out, cleaning up...');
        // Cleanup resources
        cleanupRealtime();
        user = null;
        userId = null;
        isAuthReady = false;
        currentTransactions = [];
        currentBudgets = [];
        currentCategories = { expense: [], incomeSource: [], account: [] };
        
        showAuthUI();
        
      } else if (event === 'SIGNED_IN' || event === 'USER_UPDATED' || event === 'TOKEN_REFRESHED') {
        user = session?.user ?? null;
        userId = user?.id ?? null;
        isAuthReady = !!userId;
        
        if (userId) {
          console.log('User signed in:', userId);
          hideAuthUI();
          await postSignInInit();
        } else {
          console.log('No user ID, showing auth UI');
          showAuthUI();
        }
      } else if (event === 'INITIAL_SESSION') {
        // Handle initial session
        if (session?.user) {
          user = session.user;
          userId = user.id;
          isAuthReady = true;
          hideAuthUI();
          await postSignInInit();
        } else {
          showAuthUI();
        }
      }
    });

    // Initial session check - FIXED
    (async () => {
      try {
        console.log('Checking initial session...');
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('Session check error:', error);
          throw error;
        }
        
        const session = data?.session ?? null;
        console.log('Initial session:', session ? 'Found' : 'Not found');
        
        if (session && session.user) {
          user = session.user;
          userId = user.id;
          isAuthReady = true;
          hideAuthUI();
          await postSignInInit();
        } else {
          showAuthUI();
        }
      } catch (err) {
        console.error('Error checking session', err);
        showAuthUI();
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    })();

    function showAuthUI() {
      console.log('Showing auth UI');
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('authWrapper').classList.remove('hidden');
      // Reset auth forms
      document.getElementById('loginForm').reset();
      document.getElementById('registerForm').reset();
      authMessage.textContent = '';
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    function hideAuthUI() {
      console.log('Hiding auth UI');
      document.getElementById('authWrapper').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    // After sign-in init: ensure profile exists, seed defaults, load categories/accounts, load all transactions & budgets
    async function postSignInInit() {
      if (!isAuthReady || !userId) {
        console.log('No user ID, skipping postSignInInit');
        return;
      }
      console.log('Running postSignInInit for user:', userId);
      document.getElementById('userIdDisplay').textContent = `User ID: ${userId.substring(0,8)}...`;
      
      try {
        await ensureProfileExists();
        await seedDefaults();
        await fetchCategories();
        await fetchAccounts();
        await fetchBudgets();
        await fetchTransactions();
        setupRealtime();
        renderPage('dashboard');
      } catch (error) {
        console.error('Error in postSignInInit:', error);
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    async function ensureProfileExists() {
      try {
        const { data: existing, error: selErr } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', userId)
          .limit(1)
          .maybeSingle();
        if (selErr) throw selErr;
        if (!existing) {
          const nameFromMetadata = user?.user_metadata?.full_name || user?.user_metadata?.name || (document.getElementById('regName')?.value || null);
          const fullName = nameFromMetadata || null;
          const { error: insErr } = await supabase
            .from('profiles')
            .insert([{ id: userId, email: user.email, full_name: fullName }], { returning: 'minimal' });
          if (insErr) console.warn('profile insert warning', insErr);
        }
      } catch (err) {
        console.error('ensureProfileExists error', err);
      }
    }

    async function seedDefaults() {
      try {
        const { data: catData } = await supabase.from('categories').select('id').eq('profile_id', userId).limit(1);
        if (!catData || catData.length === 0) {
          const defaultExpense = ['Makanan & Minuman', 'Transportasi', 'Tagihan', 'Hiburan'];
          const defaultIncome = ['Gaji', 'Bisnis Sampingan', 'Investasi'];
          const toInsert = [
            ...defaultExpense.map(name => ({ profile_id: userId, name, type: 'expense' })),
            ...defaultIncome.map(name => ({ profile_id: userId, name, type: 'income' }))
          ];
          const { error: insertErr } = await supabase.from('categories').insert(toInsert);
          if (insertErr) console.warn('seed categories error', insertErr);
        }

        const { data: accData } = await supabase.from('accounts').select('id').eq('profile_id', userId).limit(1);
        if (!accData || accData.length === 0) {
          const defaultAccounts = ['Kas', 'Bank Utama', 'E-Wallet'];
          const toInsertAcc = defaultAccounts.map(name => ({ profile_id: userId, name }));
          const { error: insErr } = await supabase.from('accounts').insert(toInsertAcc);
          if (insErr) console.warn('seed accounts error', insErr);
        }
      } catch (err) {
        console.error('seedDefaults error', err);
      }
    }

    // Fetch helpers
    async function fetchCategories() {
      try {
        const { data } = await supabase.from('categories').select('*').eq('profile_id', userId).order('created_at', { ascending: true });
        const rows = data || [];
        currentCategories.expense = rows.filter(r => r.type === 'expense').map(r => r.name);
        currentCategories.incomeSource = rows.filter(r => r.type === 'income').map(r => r.name);
        if (currentPage === 'transaksi') {
          renderPage('transaksi');
        } else if (currentPage === 'pengaturan') {
          renderPage('pengaturan');
        }
      } catch (err) {
        console.error('fetchCategories', err);
      }
    }
    async function fetchAccounts() {
      try {
        const { data } = await supabase.from('accounts').select('*').eq('profile_id', userId).order('created_at', { ascending: true });
        const rows = data || [];
        currentCategories.account = rows.map(r => r.name);
        if (currentPage === 'transaksi') {
          renderPage('transaksi');
        } else if (currentPage === 'pengaturan') {
          renderPage('pengaturan');
        }
      } catch (err) {
        console.error('fetchAccounts', err);
      }
    }
    async function fetchBudgets() {
      try {
        const { data } = await supabase.from('budgets').select('*').eq('profile_id', userId);
        currentBudgets = data || [];
      } catch (err) {
        console.error('fetchBudgets', err);
      }
    }
    async function fetchTransactions() {
      try {
        const { data } = await supabase.from('transactions').select('*').eq('profile_id', userId).order('date', { ascending: false });
        currentTransactions = data || [];
        if (currentPage === 'dashboard') loadDashboard(currentPeriod);
        if (currentPage === 'transaksi') renderTransactionsList();
      } catch (err) {
        console.error('fetchTransactions', err);
      }
    }

    // CRUD: categories/accounts
    async function addCategory(type, name) {
      if (!name) return showModal('Perhatian', 'Nama kategori tidak boleh kosong.');
      try {
        const { error } = await supabase.from('categories').insert([{ profile_id: userId, name, type }]);
        if (error) throw error;
        await fetchCategories();
        showModal('Sukses', `${name} berhasil ditambahkan ke ${type}.`);
      } catch (err) {
        console.error('addCategory', err);
        showModal('Gagal', `Gagal menambah kategori: ${err.message || err}`);
      }
    }
    async function deleteCategory(name) {
      try {
        const { error } = await supabase.from('categories').delete().eq('profile_id', userId).eq('name', name);
        if (error) throw error;
        await fetchCategories();
        showModal('Sukses', `${name} berhasil dihapus.`);
      } catch (err) {
        console.error('deleteCategory', err);
        showModal('Gagal', `Gagal hapus kategori: ${err.message || err}`);
      }
    }
    async function addAccount(name) {
      if (!name) return showModal('Perhatian', 'Nama akun tidak boleh kosong.');
      try {
        const { error } = await supabase.from('accounts').insert([{ profile_id: userId, name }]);
        if (error) throw error;
        await fetchAccounts();
        showModal('Sukses', `${name} berhasil ditambahkan.`);
      } catch (err) {
        console.error('addAccount', err);
        showModal('Gagal', `Gagal menambah akun: ${err.message || err}`);
      }
    }
    async function deleteAccount(name) {
      try {
        const { error } = await supabase.from('accounts').delete().eq('profile_id', userId).eq('name', name);
        if (error) throw error;
        await fetchAccounts();
        showModal('Sukses', `${name} berhasil dihapus.`);
      } catch (err) {
        console.error('deleteAccount', err);
        showModal('Gagal', `Gagal hapus akun: ${err.message || err}`);
      }
    }

    // CRUD: transactions (resolve names -> ids + store names)
    async function saveTransactionResolved(type, amount, dateStr, categoryName, accountName, description) {
      if (!isAuthReady || !userId) return;
      try {
        let category_id = null;
        if (categoryName) {
          const { data: cat } = await supabase.from('categories').select('id').eq('profile_id', userId).eq('name', categoryName).limit(1).maybeSingle();
          if (cat && cat.id) category_id = cat.id;
        }
        let account_id = null;
        if (accountName) {
          const { data: acc } = await supabase.from('accounts').select('id').eq('profile_id', userId).eq('name', accountName).limit(1).maybeSingle();
          if (acc && acc.id) account_id = acc.id;
        }

        const payload = {
          profile_id: userId,
          account_id,
          category_id,
          account_name: accountName || null,
          category_name: categoryName || null,
          type,
          amount: parseFloat(amount),
          date: dateStr,
          period: dateStr.substring(0,7),
          description: description || ''
        };

        const { error } = await supabase.from('transactions').insert([payload]);
        if (error) throw error;
        await fetchTransactions();
        showModal('Sukses', `${type} baru berhasil ditambahkan!`);
        document.getElementById('transactionForm')?.reset();
      } catch (err) {
        console.error('saveTransactionResolved error', err);
        showModal('Gagal', `Gagal menambahkan transaksi: ${err.message || err}`);
      }
    }

    async function deleteTransaction(txId) {
      if (!isAuthReady || !userId) return;
      try {
        const { error } = await supabase.from('transactions').delete().eq('id', txId).eq('profile_id', userId);
        if (error) throw error;
        await fetchTransactions();
        showModal('Sukses', 'Transaksi berhasil dihapus.');
      } catch (err) {
        console.error('deleteTransaction error', err);
        showModal('Gagal', `Gagal menghapus transaksi: ${err.message || err}`);
      }
    }

    // Budget upsert
    async function saveBudgetForPeriod(period, budgetsObj) {
      try {
        for (const categoryName of Object.keys(budgetsObj)) {
          const amount = budgetsObj[categoryName];
          const { data: cat } = await supabase.from('categories').select('id').eq('profile_id', userId).eq('name', categoryName).limit(1).maybeSingle();
          const category_id = cat?.id ?? null;
          const payload = {
            profile_id: userId,
            category_id,
            period,
            amount_limit: amount
          };
          const { error } = await supabase.from('budgets').upsert(payload, { onConflict: ['profile_id','category_id','period'] });
          if (error) throw error;
        }
        await fetchBudgets();
        showModal('Sukses', 'Budget tersimpan.');
      } catch (err) {
        console.error('saveBudgetForPeriod error', err);
        showModal('Gagal', `Gagal menyimpan budget: ${err.message || err}`);
      }
    }

    // UI rendering (templates reused from original HTML logic)
    function renderPage(pageName) {
      currentPage = pageName;
      const container = document.getElementById('pageContainer');
      const navButtons = document.querySelectorAll('.nav-link');

      navButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-page') === pageName) btn.classList.add('active');
      });

      switch (pageName) {
        case 'dashboard':
          container.innerHTML = renderDashboardPageTemplate();
          loadDashboard(currentPeriod);
          break;
        case 'transaksi':
          container.innerHTML = renderTransactionPageTemplate();
          setupTransactionForm();
          renderTransactionsList();
          break;
        case 'budget':
          container.innerHTML = renderBudgetPageTemplate();
          renderBudgetPage();
          break;
        case 'pengaturan':
          container.innerHTML = renderSettingsPageTemplate();
          renderSettingsPage();
          break;
        default:
          container.innerHTML = `<div class="p-6 text-center text-red-500">Halaman tidak ditemukan.</div>`;
      }

      if (pageName === 'dashboard') {
        document.getElementById('prevPeriod').addEventListener('click', () => changePeriod(-1));
        document.getElementById('nextPeriod').addEventListener('click', () => changePeriod(1));
      }
    }

    // Templates (copied/kept from your original layout)
    function renderDashboardPageTemplate() {
      return `
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-3 sm:space-y-0 sm:space-x-3">
          <h2 id="currentPeriodDisplay" class="text-xl font-bold">Periode: Loading...</h2>
          <div class="flex space-x-2 w-full sm:w-auto">
            <button id="prevPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
              &larr; Sebelumnya
            </button>
            <button id="nextPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
              Berikutnya &rarr;
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
          <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--income-color);">
            <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pemasukan</h3>
            <p id="totalIncome" class="text-2xl font-extrabold" style="color: var(--income-color);">Rp -</p>
          </div>
          <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--expense-color);">
            <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pengeluaran</h3>
            <p id="totalExpense" class="text-2xl font-extrabold" style="color: var(--expense-color);">Rp -</p>
          </div>
          <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--balance-color);">
            <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Saldo Bersih</h3>
            <p id="netBalance" class="text-2xl font-extrabold" style="color: var(--balance-color);">Rp -</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
          <div class="card p-4 rounded-xl lg:col-span-1">
            <h3 class="text-lg font-bold mb-2">Status Budget Pengeluaran (${formatPeriod(currentPeriod)})</h3>
            <div id="budgetStatusContainer">
              <div class="flex justify-center items-center h-24"><div class="spinner"></div></div>
            </div>
          </div>

          <div class="card p-4 rounded-xl lg:col-span-2 order-last lg:order-none">
            <h3 class="text-xl font-bold mb-2">Grafik Tren Bulanan (12 Bulan Terakhir)</h3>
            <div id="monthlyTrendChart" class="w-full" style="height: 350px;">
              <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card p-4 rounded-xl">
            <h3 class="text-lg font-bold mb-2">Proporsi Pengeluaran</h3>
            <div id="pieChartExpense" class="w-full" style="height: 300px;">
              <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
            </div>
          </div>
          <div class="card p-4 rounded-xl">
            <h3 class="text-lg font-bold mb-2">Proporsi Pemasukan</h3>
            <div id="pieChartIncome" class="w-full" style="height: 300px;">
              <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      `;
    }

    function renderTransactionPageTemplate() {
      const today = new Date().toISOString().substring(0,10);
      const expenseOptions = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      const incomeSourceOptions = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      const accountOptions = currentCategories.account.map(acc => `<option value="${acc}">${acc}</option>`).join('');
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4">Tambah Transaksi Baru</h2>
            <form id="transactionForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-1">Tipe Transaksi</label>
                <select id="txType" name="type" required class="w-full p-2 border border-gray-300 rounded-lg">
                  <option value="Pengeluaran" data-color="${expenseColor}">Pengeluaran</option>
                  <option value="Pemasukan" data-color="${incomeColor}">Pemasukan</option>
                </select>
              </div>
              <div>
                <label for="txAmount" class="block text-sm font-medium mb-1">Jumlah (Rp)</label>
                <input type="number" id="txAmount" name="amount" required min="1" class="w-full p-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label for="txDate" class="block text-sm font-medium mb-1">Tanggal</label>
                <input type="date" id="txDate" name="date" value="${today}" required class="w-full p-2 border border-gray-300 rounded-lg">
              </div>

              <div id="categoryContainer">
                <label for="txCategory" class="block text-sm font-medium mb-1" id="categoryLabel">Kategori Pengeluaran</label>
                <select id="txCategory" name="category" required class="w-full p-2 border border-gray-300 rounded-lg">
                  ${expenseOptions}
                </select>
                <p id="categoryHint" class="text-xs text-gray-500 mt-1">Pilih kategori untuk pengeluaran ini.</p>
              </div>

              <div>
                <label for="txAccount" class="block text-sm font-medium mb-1">Akun / Dompet</label>
                <select id="txAccount" name="account" required class="w-full p-2 border border-gray-300 rounded-lg">
                  ${accountOptions}
                </select>
                <p class="text-xs text-gray-500 mt-1">Akun asal uang (untuk pengeluaran) atau akun tujuan uang (untuk pemasukan).</p>
              </div>

              <div>
                <label for="txDescription" class="block text-sm font-medium mb-1">Deskripsi (Opsional)</label>
                <input type="text" id="txDescription" name="description" class="w-full p-2 border border-gray-300 rounded-lg">
              </div>

              <button type="submit" class="btn-primary w-full text-white font-semibold py-2 rounded-lg mt-2">Simpan Transaksi</button>
            </form>
          </div>

          <div class="lg:col-span-2 card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4">Daftar Semua Transaksi</h2>

            <div class="relative mb-4">
              <input type="text" id="txSearchInput" placeholder="Cari berdasarkan deskripsi atau kategori..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-1 focus:ring-green-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>

            <div class="flex space-x-3 mb-4 flex-wrap">
              <select id="txFilterType" class="p-2 border border-gray-300 rounded-lg text-sm mb-2">
                <option value="all">Semua Tipe</option>
                <option value="Pengeluaran">Pengeluaran</option>
                <option value="Pemasukan">Pemasukan</option>
              </select>
              <select id="txFilterCategory" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow mb-2">
                <option value="all">Semua Kategori/Sumber</option>
              </select>
              <select id="txFilterAccount" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow mb-2">
                <option value="all">Semua Akun/Dompet</option>
              </select>
            </div>

            <div id="transactionsList" class="space-y-3 max-h-[70vh] overflow-y-auto">
              <p class="text-gray-500 text-center p-4">Memuat transaksi...</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderBudgetPageTemplate() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1 card p-6 rounded-xl space-y-4">
            <h2 class="text-xl font-bold mb-4">Status Budget (Periode Ini)</h2>
            <div id="budgetStatusContainerPage">
              <p class="text-gray-500 text-center p-4">Memuat status budget...</p>
            </div>
          </div>

          <div class="lg:col-span-2 card p-6 rounded-xl">
            <h2 class="text-xl font-bold mb-4">Atur Budget Pengeluaran Bulanan</h2>

            <div class="flex space-x-3 mb-4 items-center flex-wrap">
              <label class="font-semibold text-gray-700">Periode Budget:</label>
              <select id="budgetPeriodSelect" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow sm:flex-grow-0 min-w-[150px] mb-2 sm:mb-0"></select>
              <button id="setBudgetBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">Tampilkan Budget</button>
            </div>

            <form id="budgetForm" class="space-y-3 p-4 border rounded-xl bg-gray-50">
              <div id="budgetInputs" class="space-y-3">
                <p class="text-gray-500">Pilih periode di atas untuk mengatur budget.</p>
              </div>
              <button type="submit" class="btn-primary w-full text-white font-semibold py-2 rounded-lg mt-4 hidden" id="saveBudgetBtn">Simpan Budget</button>
            </form>
          </div>
        </div>
      `;
    }

    function renderSettingsPageTemplate() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-bold mb-4">Pengaturan Kategori & Sumber/Akun</h2>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${expenseColor};">Kategori Pengeluaran (Expense)</h3>
              <div id="expenseCategoryList" class="mb-4 space-y-2"></div>
              <form id="addExpenseCategoryForm" class="flex space-x-2">
                <input type="text" id="newExpenseCategory" placeholder="Nama Kategori Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${incomeColor};">Sumber Pemasukan (Income Source)</h3>
              <div id="incomeSourceList" class="mb-4 space-y-2"></div>
              <form id="addIncomeSourceForm" class="flex space-x-2">
                <input type="text" id="newIncomeSource" placeholder="Nama Sumber Pemasukan Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3" style="color: ${balanceColor};">Akun / Dompet (Account)</h3>
              <div id="accountList" class="mb-4 space-y-2"></div>
              <form id="addAccountForm" class="flex space-x-2">
                <input type="text" id="newAccount" placeholder="Nama Akun/Dompet Baru (e.g., Kas, Bank)" required class="flex-grow p-2 border rounded-lg text-sm">
                <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
              </form>
              <p class="text-xs text-gray-500 mt-2">Ini adalah tempat fisik uang Anda berada.</p>
            </div>
          </div>

          <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
            <h2 class="text-xl font-bold mb-4">Pengaturan Lain</h2>

            <div class="border p-4 rounded-lg bg-gray-50">
              <h3 class="text-lg font-semibold mb-3">Pilih Tema Aplikasi</h3>
              <p class="text-sm text-gray-600">Saat ini menggunakan tema Default (Hijau Soft). Fitur kustomisasi tema akan hadir segera.</p>
              <div class="flex space-x-3 mt-3">
                <button class="bg-gray-300 py-2 px-4 rounded-lg text-sm opacity-50 cursor-not-allowed">Default (Aktif)</button>
                <button class="bg-gray-300 py-2 px-4 rounded-lg text-sm opacity-50 cursor-not-allowed">Gelap</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // UI functions: setupTransactionForm, renderTransactionsList, loadDashboard, charts, budgets, settings
    function setupTransactionForm() {
      const form = document.getElementById('transactionForm');
      if (!form) return;
      const txTypeSelect = document.getElementById('txType');
      const txCategorySelect = document.getElementById('txCategory');
      const categoryLabel = document.getElementById('categoryLabel');
      const categoryHint = document.getElementById('categoryHint');
      const filterCategorySelect = document.getElementById('txFilterCategory');
      const filterAccountSelect = document.getElementById('txFilterAccount');
      const searchInput = document.getElementById('txSearchInput');

      function updateCategoryOptions() {
        const type = txTypeSelect.value;
        let options = '';
        if (type === 'Pengeluaran') {
          options = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          categoryLabel.textContent = 'Kategori Pengeluaran';
          categoryHint.textContent = 'Pilih kategori untuk pengeluaran ini.';
        } else {
          options = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
          categoryLabel.textContent = 'Sumber Pemasukan';
          categoryHint.textContent = 'Pilih sumber dari pemasukan ini (e.g., Gaji).';
        }
        txCategorySelect.innerHTML = options || '<option value="">(Tambahkan kategori di Pengaturan)</option>';
      }

      function updateFilterOptions() {
        if (filterCategorySelect) {
          const allCategories = [
            ...currentCategories.expense.map(c => `<option value="${c}">[K] ${c}</option>`),
            ...currentCategories.incomeSource.map(c => `<option value="${c}">[S] ${c}</option>`)
          ].join('');
          filterCategorySelect.innerHTML = `<option value="all">Semua Kategori/Sumber</option>` + allCategories;
          filterCategorySelect.addEventListener('change', renderTransactionsList);
        }
        if (filterAccountSelect) {
          const allAccounts = currentCategories.account.map(acc => `<option value="${acc}">${acc}</option>`).join('');
          filterAccountSelect.innerHTML = `<option value="all">Semua Akun/Dompet</option>` + allAccounts;
          filterAccountSelect.addEventListener('change', renderTransactionsList);
        }
      }

      txTypeSelect.addEventListener('change', updateCategoryOptions);
      if (searchInput) searchInput.addEventListener('input', renderTransactionsList);

      updateCategoryOptions();
      updateFilterOptions();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = form.elements['type'].value;
        const amount = form.elements['amount'].value;
        const date = form.elements['date'].value;
        const category = form.elements['category'].value;
        const account = form.elements['account'].value;
        const description = form.elements['description'].value;
        if (!category) return showModal('Gagal', 'Kategori/Sumber harus dipilih.');
        if (!account) return showModal('Gagal', 'Akun/Dompet harus dipilih.');

        await saveTransactionResolved(type, amount, date, category, account, description);
      });
      document.getElementById('txFilterType')?.addEventListener('change', renderTransactionsList);
    }

    function renderTransactionsList() {
      const container = document.getElementById('transactionsList');
      if (!container) return;
      const filterType = document.getElementById('txFilterType')?.value || 'all';
      const filterCategory = document.getElementById('txFilterCategory')?.value || 'all';
      const filterAccount = document.getElementById('txFilterAccount')?.value || 'all';
      const searchTerm = document.getElementById('txSearchInput')?.value.toLowerCase().trim() || '';

      const filtered = (currentTransactions || [])
        .filter(tx => (filterType === 'all' || tx.type === filterType))
        .filter(tx => {
          if (filterCategory === 'all') return true;
          const name = tx.category_name || tx.category || '';
          return name === filterCategory;
        })
        .filter(tx => {
          if (filterAccount === 'all') return true;
          const a = tx.account_name || tx.account || '';
          return a === filterAccount;
        })
        .filter(tx => {
          if (!searchTerm) return true;
          const hay = `${tx.description || ''} ${tx.category_name || tx.category || ''} ${tx.account_name || tx.account || ''}`.toLowerCase();
          return hay.includes(searchTerm);
        })
        .sort((a,b) => new Date(b.date) - new Date(a.date));

      container.innerHTML = '';
      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center p-4">Belum ada transaksi. Tambahkan transaksi pertama Anda menggunakan formulir di kiri.</p>';
        return;
      }

      filtered.forEach(tx => {
        const isExpense = tx.type === 'Pengeluaran';
        const color = isExpense ? expenseColor : incomeColor;
        const sign = isExpense ? '-' : '+';
        const txEl = document.createElement('div');
        txEl.className = 'flex justify-between items-center p-3 rounded-lg card transition hover:shadow-md hover:border-gray-300';
        txEl.innerHTML = `
          <div class="flex-grow">
            <p class="font-semibold text-sm" style="color: ${color};">${tx.description || tx.category_name || tx.category || 'Transaksi'}</p>
            <p class="text-xs text-gray-500">${tx.date} | ${tx.category_name || tx.category || '-'} | Akun: ${tx.account_name || tx.account || '-'}</p>
          </div>
          <div class="flex items-center space-x-3">
            <p class="font-bold text-sm ml-2" style="color: ${color};">${sign} ${formatRupiah(tx.amount).replace('Rp','')}</p>
            <button data-id="${tx.id}" class="delete-tx-btn text-red-400 hover:text-red-600 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        `;
        container.appendChild(txEl);
      });

      container.querySelectorAll('.delete-tx-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const txId = e.currentTarget.getAttribute('data-id');
          showModal('Konfirmasi Hapus', 'Anda yakin ingin menghapus transaksi ini?', true, () => deleteTransaction(txId));
        });
      });
    }

    function loadDashboard(period) {
      currentPeriod = period || currentPeriod;
      const displayEl = document.getElementById('currentPeriodDisplay');
      if (displayEl) displayEl.textContent = `Periode: ${formatPeriod(currentPeriod)}`;

      const filteredTx = (currentTransactions || []).filter(tx => tx.period === currentPeriod);

      let totalIncome = 0;
      let totalExpense = 0;
      const expenseMap = new Map();

      filteredTx.forEach(tx => {
        const amount = Number(tx.amount) || 0;
        if (tx.type === 'Pemasukan') totalIncome += amount;
        else if (tx.type === 'Pengeluaran') {
          totalExpense += amount;
          const categoryName = tx.category_name || tx.category || 'Lain-lain';
          expenseMap.set(categoryName, (expenseMap.get(categoryName) || 0) + amount);
        }
      });

      const netBalance = totalIncome - totalExpense;
      const totalIncomeEl = document.getElementById('totalIncome');
      const totalExpenseEl = document.getElementById('totalExpense');
      const netBalanceEl = document.getElementById('netBalance');
      if (totalIncomeEl) totalIncomeEl.textContent = formatRupiah(totalIncome);
      if (totalExpenseEl) totalExpenseEl.textContent = formatRupiah(totalExpense);
      if (netBalanceEl) {
        netBalanceEl.textContent = formatRupiah(netBalance);
        netBalanceEl.style.color = netBalance >= 0 ? incomeColor : expenseColor;
      }

      if (typeof renderDashboardCharts === 'function') {
        renderDashboardCharts(filteredTx);
      } else {
        const pieExpense = document.getElementById('pieChartExpense');
        const pieIncome = document.getElementById('pieChartIncome');
        if (pieExpense) pieExpense.innerHTML = `<div class="text-sm text-gray-500 p-4">Chart pengeluaran akan tampil di sini.</div>`;
        if (pieIncome) pieIncome.innerHTML = `<div class="text-sm text-gray-500 p-4">Chart pemasukan akan tampil di sini.</div>`;
      }

      if (typeof renderMonthlyTrendChart === 'function') {
        renderMonthlyTrendChart();
      }
    }

    // Budget & Settings simplified rendering
    function renderBudgetPage() {
      const totalExpense = currentTransactions.filter(tx => tx.type === 'Pengeluaran' && tx.period === currentPeriod).reduce((s,tx) => s + (Number(tx.amount)||0),0);
      const expenseMap = currentTransactions.filter(tx => tx.type === 'Pengeluaran' && tx.period === currentPeriod).reduce((map,tx) => {
        const cat = tx.category_name || tx.category || 'Lain-lain';
        map.set(cat, (map.get(cat)||0) + (Number(tx.amount)||0));
        return map;
      }, new Map());
      renderBudgetStatusPage(totalExpense, expenseMap);

      const budgetPeriodSelect = document.getElementById('budgetPeriodSelect');
      const budgetInputsContainer = document.getElementById('budgetInputs');
      const budgetForm = document.getElementById('budgetForm');
      if (!budgetPeriodSelect) return;
      const currentMonth = new Date();
      budgetPeriodSelect.innerHTML = '';
      for (let i=-12;i<=12;i++){
        const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+i);
        const period = date.toISOString().substring(0,7);
        const display = formatPeriod(period);
        const option = document.createElement('option');
        option.value = period;
        option.textContent = display;
        if (period === currentPeriod) option.selected=true;
        budgetPeriodSelect.appendChild(option);
      }

      function populateBudgetInputs() {
        const selectedPeriod = budgetPeriodSelect.value;
        const inputs = [];
        if (currentCategories.expense.length === 0) {
          budgetInputsContainer.innerHTML = `<p class="text-red-500">Harap tambahkan Kategori Pengeluaran di halaman Pengaturan terlebih dahulu.</p>`;
          document.getElementById('saveBudgetBtn').classList.add('hidden');
          return;
        }
        currentCategories.expense.forEach(category => {
          const value = 0;
          inputs.push(`
            <div>
              <label class="block text-sm font-medium mb-1">${category}</label>
              <input type="number" data-category="${category}" value="${value}" min="0" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Budget untuk ${category}">
            </div>
          `);
        });
        budgetInputsContainer.innerHTML = inputs.join('');
        document.getElementById('saveBudgetBtn').classList.remove('hidden');
      }

      document.getElementById('setBudgetBtn').addEventListener('click', populateBudgetInputs);
      populateBudgetInputs();

      budgetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const selectedPeriod = budgetPeriodSelect.value;
        const budgetInputs = budgetInputsContainer.querySelectorAll('input');
        const newBudgets = {};
        budgetInputs.forEach(input => {
          const category = input.getAttribute('data-category');
          const amount = parseFloat(input.value) || 0;
          if (amount > 0) newBudgets[category] = amount;
        });
        if (Object.keys(newBudgets).length===0) return showModal('Perhatian','Masukkan minimal 1 nilai budget.');
        await saveBudgetForPeriod(selectedPeriod, newBudgets);
      });
    }

    function renderBudgetStatusPage(totalExpense, expenseMap) {
      const budgetContainer = document.getElementById('budgetStatusContainerPage');
      if (!budgetContainer) return;
      budgetContainer.innerHTML = `<h3 class="text-lg font-bold mb-3">Budget Periode ${formatPeriod(currentPeriod)}</h3>`;
      const periodBudget = currentBudgets.find(b => b.period===currentPeriod);
      if (!periodBudget) {
        budgetContainer.innerHTML += `<p class="text-gray-500 p-4 text-center">Belum ada budget yang ditetapkan untuk periode ini.</p>`;
        return;
      }
      budgetContainer.innerHTML += `<p class="text-sm text-gray-600">Budget detail ditemukan, buka input Budget untuk melihat & ubah.</p>`;
    }

    function renderSettingsPage() {
      const expenseList = document.getElementById('expenseCategoryList');
      if (expenseList) {
        expenseList.innerHTML = currentCategories.expense.map(cat => `
            <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-red-100">
                <span>${cat}</span>
                <button data-name="${cat}" data-type="expense" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
            </div>
        `).join('');
      }
      const incomeSourceList = document.getElementById('incomeSourceList');
      if (incomeSourceList) {
        incomeSourceList.innerHTML = currentCategories.incomeSource.map(cat => `
            <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-green-100">
                <span>${cat}</span>
                <button data-name="${cat}" data-type="income" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
            </div>
        `).join('');
      }
      const accountList = document.getElementById('accountList');
      if (accountList) {
        accountList.innerHTML = currentCategories.account.map(cat => `
            <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-blue-100">
                <span>${cat}</span>
                <button data-name="${cat}" data-type="account" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
            </div>
        `).join('');
      }

      document.getElementById('addExpenseCategoryForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newExpenseCategory');
        addCategory('expense', input.value.trim());
        input.value = '';
      });
      document.getElementById('addIncomeSourceForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newIncomeSource');
        addCategory('income', input.value.trim());
        input.value = '';
      });
      document.getElementById('addAccountForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('newAccount');
        addAccount(input.value.trim());
        input.value = '';
      });

      document.querySelectorAll('.delete-cat-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const name = e.currentTarget.getAttribute('data-name');
          const type = e.currentTarget.getAttribute('data-type');
          showModal('Konfirmasi Hapus', `Yakin ingin menghapus item "${name}" dari ${type}?`, true, () => {
            if (type === 'account') deleteAccount(name);
            else deleteCategory(name);
          });
        });
      });
    }

    function formatPeriod(period) {
      if (!period) return 'N/A';
      const [year, month] = period.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
    }

    function changePeriod(offset) {
      const [year, month] = currentPeriod.split('-').map(Number);
      const date = new Date(year, month - 1);
      date.setMonth(date.getMonth() + offset);
      const newYear = date.getFullYear();
      const newMonth = String(date.getMonth() + 1).padStart(2, '0');
      currentPeriod = `${newYear}-${newMonth}`;
      if (currentPage === 'dashboard') loadDashboard(currentPeriod);
      else if (currentPage === 'budget') renderBudgetPage();
    }

    // wire nav buttons
    document.querySelectorAll('.nav-link').forEach(button => {
      button.addEventListener('click', (e) => {
        renderPage(e.target.getAttribute('data-page'));
      });
    });

    // attach resize handler to redraw charts if functions available
    window.addEventListener('resize', () => {
      if (currentPage === 'dashboard') loadDashboard(currentPeriod);
    });

    // initial UI: if not signed in, show auth UI
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loadingOverlay').classList.add('hidden');
      // If user signed in, initialSession check above will handle; else show auth
    });

  </script>
</body>
</html>
