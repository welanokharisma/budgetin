<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budgetin</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  
  <style>
    /* ---------------------------------------------------------------------- */
    /* 1. DEFINISI TEMA (Menggunakan Tema Hijau Soft Default) */
    /* ---------------------------------------------------------------------- */
    
    :root {
      /* Warna Dasar Tema Hijau-Putih (Light Soft Theme) */
      --color-white-bg: #FFFFFF;
      --color-light-bg: #FAF9F6;
      --color-dark-text: #333333;
      --color-green-primary: #7CD18B; /* Pemasukan */
      --color-red-expense: #F0939A; /* Pengeluaran */
      --color-border-classic: #E0E0E0;
      --color-balance-blue: #8AB8DE; /* Saldo */
      --color-header-green: #6AA573; /* Primary Accent */

      /* Mapping ke Variabel Aplikasi */
      --bg-color: var(--color-light-bg);
      --card-bg: var(--color-white-bg);
      --text-color: var(--color-dark-text);
      --income-color: var(--color-green-primary);
      --expense-color: var(--color-red-expense);
      --balance-color: var(--color-balance-blue);
      --primary-accent: var(--color-header-green);
      --chart-bg: var(--color-white-bg);
      --chart-text: var(--color-dark-text);
      
      /* Font Family */
      --font-family-sans: 'Inter', sans-serif;
    }

    /* ---------------------------------------------------------------------- */
    /* 2. BASE STYLING & UTILITIES */
    /* ---------------------------------------------------------------------- */
    body {
      font-family: var(--font-family-sans);
      background-color: var(--bg-color);
      color: var(--text-color);
    }
    
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--color-border-classic);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }

    .btn-primary {
      background-color: var(--primary-accent);
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background-color: #5a8a61;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .period-button {
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .nav-link {
        padding: 0.75rem 1.25rem;
        transition: all 0.2s;
        border-radius: 0.5rem;
        font-weight: 600;
        text-align: center;
    }
    .nav-link.active {
        background-color: var(--primary-accent);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .nav-link:not(.active):hover {
        background-color: #e5e7eb;
    }
  </style>
</head>

<body class="min-h-screen p-2 sm:p-4 md:p-6">
  
  <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center transition-opacity duration-300">
    <div class="spinner"></div>
    <p class="ml-4 text-lg font-semibold text-gray-700">Memuat Aplikasi...</p>
  </div>
  
  <div id="authContainer" class="hidden min-h-screen flex items-center justify-center p-4">
    <div class="card p-8 rounded-xl w-full max-w-md">
      <h2 class="text-3xl font-extrabold text-center mb-6" style="color: var(--primary-accent);">Budgetin Login</h2>
      
      <form id="authForm" class="space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium mb-1">Email</label>
          <input type="email" id="email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <button id="authSubmitBtn" type="submit" class="btn-primary w-full text-white font-semibold py-3 rounded-lg shadow-md mt-4">Login</button>
      </form>
      
      <p class="text-center mt-4 text-sm">
        Belum punya akun? 
        <button id="toggleAuthBtn" class="font-semibold" style="color: var(--primary-accent);">
          Daftar Sekarang
        </button>
      </p>
      <div id="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
    </div>
  </div>

  
  <div id="mainContent" class="hidden max-w-7xl mx-auto">
    
    <header class="mb-6 p-4 rounded-xl bg-white shadow-lg">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
        <h1 class="text-3xl font-extrabold" style="color: var(--primary-accent);">Budgetin</h1>
        <div class="flex items-center space-x-4">
            <p id="userIdDisplay" class="text-xs mt-2 sm:mt-0 p-1 bg-gray-100 rounded-full inline-block text-gray-600"></p>
            <button id="logoutBtn" class="text-red-500 hover:text-red-700 font-semibold text-sm transition">Logout</button>
        </div>
      </div>

      <nav class="flex flex-wrap justify-center sm:justify-start gap-2">
        <button class="nav-link active" data-page="dashboard">Dashboard</button>
        <button class="nav-link" data-page="transaksi">Transaksi</button>
        <button class="nav-link" data-page="budget">Budget</button>
        <button class="nav-link" data-page="pengaturan">Pengaturan</button>
      </nav>
    </header>

    <div id="pageContainer">
      </div>
    
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center p-4" onclick="closeModal()">
    <div class="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl" onclick="event.stopPropagation()">
      <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">Notifikasi</h3>
      <p id="modalMessage" class="text-gray-600 mb-4"></p>
      <div class="flex justify-end space-x-3">
        <button id="modalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hidden">Konfirmasi</button>
        <button id="modalCloseBtn" class="btn-primary text-white py-2 px-4 rounded-lg font-semibold">Tutup</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    // ----------------------------------------------------------------------
    // [INTEGRASI SUPABASE] - TELAH DIGANTI DENGAN KUNCI PROYEK ANDA
    // ----------------------------------------------------------------------
    const SUPABASE_URL = 'https://xzlggtyvgnyzzofgudwa.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6bGdndHl2Z255enpvZmd1ZHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MDk0MjcsImV4cCI6MjA3NzQ4NTQyN30.x77c3j7TfL5_tQStYNSurhEC6gUDIasuVUk8YpJAi5E'; 

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // END [INTEGRASI SUPABASE]
    
    // Variabel Global
    let userId = null;
    let currentPeriod = new Date().toISOString().substring(0, 7); // Format YYYY-MM
    let isAuthReady = false;
    let currentTransactions = [];
    let currentBudgets = [];
    
    // Kategori sekarang dipisah: expense, incomeSource, account
    let currentCategories = { 
        expense: ['Makanan & Minuman', 'Transportasi', 'Tagihan', 'Hiburan'], 
        incomeSource: ['Gaji', 'Bisnis Sampingan', 'Investasi'],
        account: ['Kas', 'Bank Utama', 'E-Wallet']
    };
    
    // Mendapatkan variabel CSS untuk Chart Styling
    const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--color-red-expense').trim();
    const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-green-primary').trim();
    const balanceColor = getComputedStyle(document.documentElement).getPropertyValue('--color-balance-blue').trim();
    const chartBg = getComputedStyle(document.documentElement).getPropertyValue('--chart-bg').trim();
    const chartText = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
    const primaryAccent = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent').trim();
    
    // ----------------------------------------------------------------------
    // FUNGSI UTILITY
    // ----------------------------------------------------------------------
    
    /** Mengubah Angka menjadi format Rupiah */
    const formatRupiah = (number) => {
      if (number === null || number === undefined || isNaN(number)) return 'Rp -';
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(number);
    };

    /** Menampilkan Modal Kustom (Ganti alert/confirm) */
    function showModal(title, message, isConfirm = false, onConfirm = () => {}) {
        const modal = document.getElementById('modal');
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const closeBtn = document.getElementById('modalCloseBtn');
        
        if (isConfirm) {
            confirmBtn.classList.remove('hidden');
            confirmBtn.onclick = () => { onConfirm(); closeModal(); };
        } else {
            confirmBtn.classList.add('hidden');
        }
        
        closeBtn.onclick = closeModal;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    /** Menutup Modal Kustom */
    function closeModal() {
        const modal = document.getElementById('modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    /** Mengubah format YYYY-MM menjadi Nama Bulan YYYY */
    function formatPeriod(period) {
        if (!period) return 'N/A';
        const [year, month] = period.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
    }

    // ----------------------------------------------------------------------
    // SUPABASE AUTHENTICATION
    // ----------------------------------------------------------------------

    /** Menampilkan/Menyembunyikan Konten Aplikasi */
    function toggleAppContent(isAuthenticated) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContent = document.getElementById('mainContent');
        const authContainer = document.getElementById('authContainer');
        
        loadingOverlay.classList.add('hidden');

        if (isAuthenticated) {
            authContainer.classList.add('hidden');
            authContainer.classList.remove('flex');
            mainContent.classList.remove('hidden');
            document.getElementById('userIdDisplay').textContent = `User ID: ${userId.substring(0, 8)}...`;
            
            if (!isAuthReady) {
                isAuthReady = true;
                setupListeners();
                renderPage('dashboard');
            }
        } else {
            mainContent.classList.add('hidden');
            authContainer.classList.remove('hidden');
            authContainer.classList.add('flex');
            isAuthReady = false;
        }
    }

    /** Menginisialisasi Supabase dan Mengatur Listener Auth */
    async function initializeSupabase() {
        const { data: { user } } = await supabase.auth.getUser();

        if (user) {
            userId = user.id;
            toggleAppContent(true);
        } else {
            toggleAppContent(false);
        }
        
        // Listener Auth (Untuk auto-refresh setelah login/logout)
        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                userId = session.user.id;
                toggleAppContent(true);
            } else {
                userId = null;
                toggleAppContent(false);
            }
        });
        
        setupAuthForm();
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    }
    
    /** Setup Form Login/Register */
    function setupAuthForm() {
        const form = document.getElementById('authForm');
        const submitBtn = document.getElementById('authSubmitBtn');
        const toggleBtn = document.getElementById('toggleAuthBtn');
        const errorDiv = document.getElementById('authError');
        
        let isLoginMode = true;

        const updateForm = () => {
            submitBtn.textContent = isLoginMode ? 'Login' : 'Daftar';
            toggleBtn.textContent = isLoginMode ? 'Daftar Sekarang' : 'Login Sekarang';
            errorDiv.classList.add('hidden');
        };

        toggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            updateForm();
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner w-5 h-5 border-2 border-l-white border-l-transparent mr-2"></span> Memproses...';
            
            let result;
            if (isLoginMode) {
                result = await supabase.auth.signInWithPassword({ email, password });
            } else {
                // Supabase menyimpan sesi secara otomatis setelah pendaftaran
                result = await supabase.auth.signUp({ email, password });
            }

            if (result.error) {
                errorDiv.textContent = result.error.message;
                errorDiv.classList.remove('hidden');
                submitBtn.textContent = isLoginMode ? 'Login' : 'Daftar';
                submitBtn.disabled = false;
            } else if (result.data.user) {
                // Otentikasi sukses, listener onAuthStateChange akan memanggil toggleAppContent(true)
                showModal("Sukses", isLoginMode ? "Berhasil Login!" : "Pendaftaran Berhasil! Anda sudah login.");
            }
        });
        
        updateForm();
    }
    
    /** Handle Logout */
    async function handleLogout() {
        const { error } = await supabase.auth.signOut();
        if (error) {
            console.error("Logout error:", error);
            showModal("Gagal Logout", error.message);
        } else {
            showModal("Sukses", "Anda telah berhasil logout.");
        }
    }


    // ----------------------------------------------------------------------
    // SUPABASE DATA LISTENERS (Mengambil semua data)
    // ----------------------------------------------------------------------
    
    /** Mengambil semua data dari Supabase (Menggantikan Listener Firebase) */
    async function setupListeners() {
        if (!userId) return;
        
        // 1. Ambil Transaksi
        const { data: txData, error: txError } = await supabase
            .from('transactions')
            .select('*')
            .eq('user_id', userId)
            .order('date', { ascending: false });

        if (txError) {
            console.error("Error fetching transactions:", txError);
            showModal("Gagal", `Gagal memuat transaksi: ${txError.message}`);
        } else {
            currentTransactions = txData;
        }

        // 2. Ambil Budget
        const { data: budgetData, error: budgetError } = await supabase
            .from('budgets')
            .select('*')
            .eq('user_id', userId);
        
        if (budgetError) {
            console.error("Error fetching budgets:", budgetError);
        } else {
            currentBudgets = budgetData;
        }
        
        // 3. Ambil Kategori/Settings
        const { data: catData, error: catError } = await supabase
            .from('categories')
            .select('expense, income_source, account')
            .eq('user_id', userId)
            .single();

        if (catError && catError.code !== 'PGRST116') { // PGRST116 = tidak ditemukan (boleh)
            console.error("Error fetching categories:", catError);
            // Jika error lain, gunakan default
        } else if (catData) {
            // Mapping dari snake_case Supabase ke camelCase JS
            currentCategories.expense = catData.expense || [];
            currentCategories.incomeSource = catData.income_source || []; 
            currentCategories.account = catData.account || []; 
        } else {
             // Jika dokumen setting belum ada, simpan kategori default ke database
             await saveCategories();
        }
        
        // Muat ulang data yang bergantung pada transaksi (Dashboard, Transaksi)
        if (currentPage === 'dashboard') loadDashboard(currentPeriod);
        if (currentPage === 'transaksi') {
             setupTransactionForm(); // Update filter options
             renderTransactionsList();
        }
        if (currentPage === 'budget') renderBudgetPage();
        if (currentPage === 'pengaturan') renderSettingsPage();
    }

    // ----------------------------------------------------------------------
    // CORE CRUD FUNCTION (Transaksi) - SUPABASE
    // ----------------------------------------------------------------------
    
    /** Menyimpan transaksi baru (Pemasukan/Pengeluaran) */
    async function saveTransaction(type, amount, dateStr, category, account, description) {
        if (!userId) return showModal("Error", "Otentikasi pengguna hilang.");

        const date = new Date(dateStr);
        const period = dateStr.substring(0, 7); // YYYY-MM
        
        try {
            const { data, error } = await supabase
                .from('transactions')
                .insert([{
                    user_id: userId,
                    type: type, 
                    amount: parseFloat(amount),
                    date: dateStr,
                    period: period,
                    category: category, 
                    account: account, 
                    description: description || ''
                }])
                .select(); 

            if (error) throw error;
            
            showModal("Sukses", `${type} baru berhasil ditambahkan!`);
            document.getElementById('transactionForm').reset();
            
            // Refresh data setelah insert
            await setupListeners(); 

        } catch (e) {
            console.error("Error adding transaction: ", e);
            showModal("Gagal", `Gagal menambahkan ${type}: ${e.message}`);
        }
    }
    
    /** Menghapus Transaksi */
    async function deleteTransaction(txId) {
        if (!userId) return showModal("Error", "Otentikasi pengguna hilang.");
        try {
            const { error } = await supabase
                .from('transactions')
                .delete()
                .eq('id', txId)
                .eq('user_id', userId); // Pastikan hanya menghapus milik sendiri

            if (error) throw error;

            showModal("Sukses", "Transaksi berhasil dihapus.");
            await setupListeners(); // Refresh data

        } catch (e) {
            console.error("Error deleting transaction: ", e);
            showModal("Gagal", `Gagal menghapus transaksi: ${e.message}`);
        }
    }

    // ----------------------------------------------------------------------
    // CORE CRUD FUNCTION (Budget) - SUPABASE
    // ----------------------------------------------------------------------
    
    /** Menyimpan Budget */
    async function saveBudget(period, newBudgets) {
        if (!userId) return showModal("Error", "Otentikasi pengguna hilang.");
        
        try {
            const { error } = await supabase
                .from('budgets')
                .upsert({ 
                    user_id: userId, 
                    period: period, 
                    budgets: newBudgets 
                }, { 
                    onConflict: 'user_id, period' // Upsert berdasarkan user_id dan period
                });

            if (error) throw error;
            
            showModal("Sukses", `Budget untuk ${formatPeriod(period)} berhasil disimpan!`);
            await setupListeners(); // Refresh data
        } catch (error) {
            console.error("Error saving budget:", error);
            showModal("Gagal", `Gagal menyimpan budget: ${error.message}`);
        }
    }
    
    // ----------------------------------------------------------------------
    // CORE CRUD FUNCTION (Pengaturan/Kategori) - SUPABASE
    // ----------------------------------------------------------------------

    /** Menyimpan daftar kategori saat ini ke Supabase */
    async function saveCategories() {
        if (!userId) return showModal("Error", "Otentikasi pengguna hilang.");

        try {
            // Upsert (Insert atau Update) kategori
            const { error } = await supabase
                .from('categories')
                .upsert({
                    user_id: userId,
                    expense: currentCategories.expense,
                    income_source: currentCategories.incomeSource,
                    account: currentCategories.account
                }, {
                    onConflict: 'user_id' // Selalu upsert berdasarkan user_id
                });
            
            if (error) throw error;
            
            // Jika berhasil disimpan, pastikan currentCategories memiliki nilai default jika sebelumnya kosong
            if (currentCategories.expense.length === 0) {
                 // Inisialisasi default jika dokumen setting belum ada
                 currentCategories = { 
                    expense: ['Makanan & Minuman', 'Transportasi', 'Tagihan', 'Hiburan'], 
                    incomeSource: ['Gaji', 'Bisnis Sampingan', 'Investasi'],
                    account: ['Kas', 'Bank Utama', 'E-Wallet']
                 };
            }

        } catch (e) {
            console.error("Error saving categories:", e);
        }
    }
    
    /** Menambah atau menghapus item Kategori/Sumber/Akun */
    function manageCategory(type, action, name) {
        if (!name) return showModal("Perhatian", "Nama tidak boleh kosong.");
        const list = currentCategories[type];
        name = name.trim();

        if (action === 'add') {
            if (list.map(n => n.toLowerCase()).includes(name.toLowerCase())) {
                return showModal("Perhatian", `${name} sudah ada dalam daftar.`);
            }
            list.push(name);
            showModal("Sukses", `${name} berhasil ditambahkan ke ${type}.`);
        } else if (action === 'delete') {
            const index = list.indexOf(name);
            if (index > -1) {
                // Konfirmasi dulu sebelum menghapus
                showModal("Konfirmasi Hapus", `Yakin ingin menghapus item "${name}" dari ${type}?`, true, async () => {
                    list.splice(index, 1);
                    await saveCategories();
                    showModal("Sukses", `${name} berhasil dihapus dari ${type}.`);
                    renderPage(currentPage); // Render ulang halaman setelah konfirmasi
                });
                return; // Keluar dari fungsi manageCategory agar tidak double save/render
            }
        }
        
        // Simpan perubahan ke Supabase
        saveCategories();
        // Render ulang halaman
        renderPage(currentPage);
    }
    
    // ----------------------------------------------------------------------
    // FUNGSI LAINNYA
    // ----------------------------------------------------------------------
    
    /** Memuat semua data Dashboard untuk periode yang diberikan */
    function loadDashboard(period) {
        updatePeriodDisplay(period);
        const filteredTx = currentTransactions.filter(tx => tx.period === period);
        
        // 1. Hitung Ringkasan Periode
        let totalIncome = 0;
        let totalExpense = 0;
        const expenseMap = new Map();

        filteredTx.forEach(tx => {
            const amount = tx.amount || 0;
            const category = tx.category || 'Lain-lain';

            if (tx.type === 'Pemasukan') {
                totalIncome += amount;
            } else if (tx.type === 'Pengeluaran') {
                totalExpense += amount;
                expenseMap.set(category, (expenseMap.get(category) || 0) + amount);
            }
        });

        const netBalance = totalIncome - totalExpense;
        
        // Update Summary Cards
        document.getElementById('totalIncome').textContent = formatRupiah(totalIncome);
        document.getElementById('totalExpense').textContent = formatRupiah(totalExpense);
        const netBalanceEl = document.getElementById('netBalance');
        netBalanceEl.textContent = formatRupiah(netBalance);
        netBalanceEl.style.color = netBalance >= 0 ? incomeColor : expenseColor;

        // 2. Render Status Budget
        renderBudgetStatus(totalExpense, expenseMap);

        // 3. Render Charts (Tren Bulanan dan Pie Charts)
        renderDashboardCharts(filteredTx);
        renderMonthlyTrendChart(); // Memanggil fungsi baru untuk Bar Chart
    }
    
    /** Render Status Budget Pengeluaran */
    function renderBudgetStatus(totalExpense, expenseMap) {
        const budgetContainer = document.getElementById('budgetStatusContainer');
        if (!budgetContainer) return;
        
        budgetContainer.innerHTML = ''; // Clear previous content
        
        const periodBudget = currentBudgets.find(b => b.period === currentPeriod);
        
        if (!periodBudget || Object.keys(periodBudget.budgets).length === 0) {
            budgetContainer.innerHTML = `<p class="text-gray-500 p-4 text-center">Belum ada budget yang ditetapkan untuk periode ini.</p>`;
            return;
        }

        let totalBudget = 0;
        let totalUsed = 0;
        let detailsHtml = ''; // Untuk menyimpan detail per kategori

        // Hitung total budget dan render status per kategori
        Object.keys(periodBudget.budgets).forEach(category => {
            const budgetAmount = periodBudget.budgets[category] || 0;
            const usedAmount = expenseMap.get(category) || 0;
            
            totalBudget += budgetAmount;
            totalUsed += usedAmount;
            
            const remaining = budgetAmount - usedAmount;
            const usagePercentage = budgetAmount > 0 ? (usedAmount / budgetAmount) * 100 : 0;
            const progressBarColor = usagePercentage > 90 ? 'bg-red-500' : usagePercentage > 70 ? 'bg-yellow-500' : 'bg-green-500';
            const progressWidth = Math.min(usagePercentage, 100);

            detailsHtml += `
                <div class="mb-4 p-3 rounded-lg bg-gray-50 border border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm">${category}</span>
                        <span class="text-sm font-bold" style="color: ${remaining >= 0 ? incomeColor : expenseColor};">
                            ${formatRupiah(remaining)} tersisa
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">
                        ${formatRupiah(usedAmount)} dari ${formatRupiah(budgetAmount)}
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${progressBarColor}" style="width: ${progressWidth}%;"></div>
                    </div>
                </div>
            `;
        });
        
        // Tambahkan ringkasan total
        budgetContainer.innerHTML = `
            <h4 class="text-lg font-bold mb-3">Ringkasan Budget</h4>
            <div class="grid grid-cols-3 gap-2 text-center text-sm font-semibold mb-4 border-b pb-2">
                <p>Budget: ${formatRupiah(totalBudget)}</p>
                <p class="text-gray-700">Terpakai: ${formatRupiah(totalUsed)}</p>
                <p style="color: ${totalBudget - totalUsed >= 0 ? primaryAccent : expenseColor};">Sisa: ${formatRupiah(totalBudget - totalUsed)}</p>
            </div>
            ${detailsHtml}
        `;
    }

    /** Render Semua Charts Dashboard (Proporsi Pengeluaran & Pemasukan) */
    function renderDashboardCharts(transactions) {
        const expenseMap = new Map();
        const incomeMap = new Map();
        
        transactions.forEach(tx => {
            const amount = tx.amount || 0;
            const category = tx.category || 'Lain-lain';
            
            if (tx.type === 'Pengeluaran') {
                expenseMap.set(category, (expenseMap.get(category) || 0) + amount);
            } else if (tx.type === 'Pemasukan') {
                // Di dashboard, Pemasukan dipetakan berdasarkan Sumber Pemasukan (category)
                incomeMap.set(category, (incomeMap.get(category) || 0) + amount);
            }
        });
        
        // Format data
        const expenseChartData = [['Kategori', 'Jumlah Pengeluaran']];
        expenseMap.forEach((amount, category) => expenseChartData.push([category, amount]));
        
        const incomeChartData = [['Sumber', 'Jumlah Pemasukan']];
        incomeMap.forEach((amount, category) => incomeChartData.push([category, amount]));

        // Gambar Chart
        drawPieChart('pieChartExpense', expenseChartData, 'Pengeluaran');
        drawPieChart('pieChartIncome', incomeChartData, 'Pemasukan');
    }

    /** Fungsi untuk menggambar Google Pie Chart */
    function drawPieChart(elementId, arrayData, title) {
        const el = document.getElementById(elementId);
        if (!el) return;

        if (arrayData.length <= 1) {
            el.innerHTML = `<div class="flex justify-center items-center h-full text-gray-500">Tidak ada data ${title} di periode ini.</div>`;
            return;
        }
        
        google.charts.load('current', { packages: ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            const data = google.visualization.arrayToDataTable(arrayData);
            
            const colors = [expenseColor, incomeColor, balanceColor, '#8AA694', '#E6B89C', '#B0C4DE', '#A9A9A9'];

            const options = {
                title: '',
                backgroundColor: chartBg,
                legend: { position: 'bottom', textStyle: { color: chartText } },
                pieHole: 0.3,
                colors: colors.slice(0, arrayData.length - 1),
                chartArea: { left: '5%', top: '5%', width: '90%', height: '80%' },
                tooltip: { textStyle: { color: chartText } }
            };
            
            const chart = new google.visualization.PieChart(el);
            chart.draw(data, options);
        });
    }

    /** Menggambar Bar Chart Tren Bulanan */
    function renderMonthlyTrendChart() {
        const trendEl = document.getElementById('monthlyTrendChart');
        if (!trendEl) return;
        
        // 1. Kumpulkan data untuk 12 bulan terakhir
        const monthlyData = {};
        const today = new Date();
        
        // Inisialisasi 12 bulan terakhir
        for (let i = 11; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const period = date.toISOString().substring(0, 7);
            const label = date.toLocaleString('id-ID', { month: 'short' });
            monthlyData[period] = { month: label, income: 0, expense: 0 };
        }
        
        // Isi data dari transaksi
        currentTransactions.forEach(tx => {
            if (monthlyData[tx.period]) {
                if (tx.type === 'Pemasukan') {
                    monthlyData[tx.period].income += tx.amount || 0;
                } else if (tx.type === 'Pengeluaran') {
                    monthlyData[tx.period].expense += tx.amount || 0;
                }
            }
        });
        
        // 2. Format data untuk Google Chart
        const chartDataArray = [['Bulan', 'Pemasukan', 'Pengeluaran']];
        Object.keys(monthlyData).sort().forEach(period => {
            const data = monthlyData[period];
            chartDataArray.push([data.month, data.income, data.expense]);
        });

        // 3. Gambar Bar Chart
        if (chartDataArray.length <= 1) {
            trendEl.innerHTML = `<div class="flex justify-center items-center h-full text-gray-500">Tidak ada data transaksi yang cukup untuk menampilkan tren bulanan (minimal 1 bulan transaksi).</div>`;
            return;
        }

        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            const data = google.visualization.arrayToDataTable(chartDataArray);

            const options = {
                title: '',
                backgroundColor: chartBg,
                legend: { position: 'top', textStyle: { color: chartText } },
                vAxis: { 
                    title: 'Jumlah (Rp)', 
                    textStyle: { color: chartText },
                    gridlines: { color: '#f0f0f0' }
                },
                hAxis: { 
                    title: 'Bulan', 
                    textStyle: { color: chartText } 
                },
                series: {
                    0: { color: incomeColor }, // Pemasukan
                    1: { color: expenseColor }  // Pengeluaran
                },
                chartArea: { width: '85%', height: '75%' },
                tooltip: { isHtml: true } // Memungkinkan tooltip kustom
            };

            const chart = new google.visualization.ColumnChart(trendEl);
            chart.draw(data, options);
        });
    }

    // ----------------------------------------------------------------------
    // NAVIGATION AND PERIOD CONTROL
    // ----------------------------------------------------------------------
    
    let currentPage = 'dashboard';

    /** Mengganti halaman yang ditampilkan */
    function renderPage(pageName) {
        if (!userId) {
            toggleAppContent(false);
            return;
        }
        
        currentPage = pageName;
        const container = document.getElementById('pageContainer');
        const navButtons = document.querySelectorAll('.nav-link');
        
        // Update Navigasi Aktif
        navButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-page') === pageName) {
                btn.classList.add('active');
            }
        });

        // Render Konten Sesuai Halaman
        switch (pageName) {
            case 'dashboard':
                container.innerHTML = renderDashboardPageTemplate();
                loadDashboard(currentPeriod);
                break;
            case 'transaksi':
                container.innerHTML = renderTransactionPageTemplate();
                setupTransactionForm();
                renderTransactionsList(); 
                break;
            case 'budget':
                container.innerHTML = renderBudgetPageTemplate();
                renderBudgetPage();
                break;
            case 'pengaturan':
                container.innerHTML = renderSettingsPageTemplate();
                renderSettingsPage();
                break;
            default:
                container.innerHTML = `<div class="p-6 text-center text-red-500">Halaman tidak ditemukan.</div>`;
        }
        
        // Setup listener navigasi periode hanya jika di Dashboard
        if (pageName === 'dashboard') {
             document.getElementById('prevPeriod').addEventListener('click', () => changePeriod(-1));
             document.getElementById('nextPeriod').addEventListener('click', () => changePeriod(1));
        }
    }
    
    /** Template Halaman Dashboard (Layout Tren di bawah Budget) */
    function renderDashboardPageTemplate() {
        return `
            <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-3 sm:space-y-0 sm:space-x-3">
              <h2 id="currentPeriodDisplay" class="text-xl font-bold">Periode: Loading...</h2>
              <div class="flex space-x-2 w-full sm:w-auto">
                <button id="prevPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                  &larr; Sebelumnya
                </button>
                <button id="nextPeriod" class="period-button btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                  Berikutnya &rarr;
                </button>
              </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
              <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--income-color);">
                <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pemasukan</h3>
                <p id="totalIncome" class="text-2xl font-extrabold" style="color: var(--income-color);">Rp -</p>
              </div>
              
              <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--expense-color);">
                <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Total Pengeluaran</h3>
                <p id="totalExpense" class="text-2xl font-extrabold" style="color: var(--expense-color);">Rp -</p>
              </div>
              
              <div class="card p-5 rounded-xl transition duration-300 hover:shadow-xl" style="border-left: 5px solid var(--balance-color);">
                <h3 class="text-sm font-semibold uppercase text-gray-500 mb-1">Saldo Bersih</h3>
                <p id="netBalance" class="text-2xl font-extrabold" style="color: var(--balance-color);">Rp -</p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                
                <div class="card p-4 rounded-xl lg:col-span-1">
                    <h3 class="text-lg font-bold mb-2">Status Budget Pengeluaran (${formatPeriod(currentPeriod)})</h3>
                    <div id="budgetStatusContainer">
                        <div class="flex justify-center items-center h-24"><div class="spinner"></div></div>
                    </div>
                </div>
                
                <div class="card p-4 rounded-xl lg:col-span-2 order-last lg:order-none">
                    <h3 class="text-xl font-bold mb-2">Grafik Tren Bulanan (12 Bulan Terakhir)</h3>
                    <div id="monthlyTrendChart" class="w-full" style="height: 350px;">
                        <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
                    </div>
                </div>

            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-4 rounded-xl">
                  <h3 class="text-lg font-bold mb-2">Proporsi Pengeluaran</h3>
                  <div id="pieChartExpense" class="w-full" style="height: 300px;">
                    <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
                  </div>
                </div>
                
                <div class="card p-4 rounded-xl">
                  <h3 class="text-lg font-bold mb-2">Proporsi Pemasukan</h3>
                  <div id="pieChartIncome" class="w-full" style="height: 300px;">
                    <div class="flex justify-center items-center h-full"><div class="spinner"></div></div>
                  </div>
                </div>
            </div>
        `;
    }
    
    /** Template Halaman Transaksi */
    function renderTransactionPageTemplate() {
        // Mendapatkan tanggal hari ini dalam format YYYY-MM-DD
        const today = new Date().toISOString().substring(0, 10);

        // Opsi Kategori untuk Form
        const expenseOptions = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        const incomeSourceOptions = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        const accountOptions = currentCategories.account.map(acc => `<option value="${acc}">${acc}</option>`).join(''); 

        return `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4">Tambah Transaksi Baru</h2>
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Tipe Transaksi</label>
                            <select id="txType" name="type" required class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="Pengeluaran" data-color="${expenseColor}">Pengeluaran</option>
                                <option value="Pemasukan" data-color="${incomeColor}">Pemasukan</option>
                            </select>
                        </div>
                        <div>
                            <label for="txAmount" class="block text-sm font-medium mb-1">Jumlah (Rp)</label>
                            <input type="number" id="txAmount" name="amount" required min="1" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="txDate" class="block text-sm font-medium mb-1">Tanggal</label>
                            <input type="date" id="txDate" name="date" value="${today}" required class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <div id="categoryContainer">
                            <label for="txCategory" class="block text-sm font-medium mb-1" id="categoryLabel">Kategori Pengeluaran</label>
                            <select id="txCategory" name="category" required class="w-full p-2 border border-gray-300 rounded-lg">
                                ${expenseOptions}
                            </select>
                            <p id="categoryHint" class="text-xs text-gray-500 mt-1">Pilih kategori untuk pengeluaran ini.</p>
                        </div>
                        
                        <div>
                            <label for="txAccount" class="block text-sm font-medium mb-1">Akun / Dompet</label>
                            <select id="txAccount" name="account" required class="w-full p-2 border border-gray-300 rounded-lg">
                                ${accountOptions}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Akun asal uang (untuk pengeluaran) atau akun tujuan uang (untuk pemasukan).</p>
                        </div>

                        <div>
                            <label for="txDescription" class="block text-sm font-medium mb-1">Deskripsi (Opsional)</label>
                            <input type="text" id="txDescription" name="description" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full text-white font-semibold py-2 rounded-lg mt-2">Simpan Transaksi</button>
                    </form>
                </div>

                <div class="lg:col-span-2 card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4">Daftar Semua Transaksi</h2>
                    
                    <div class="relative mb-4">
                        <input type="text" id="txSearchInput" placeholder="Cari berdasarkan deskripsi atau kategori..." class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-1 focus:ring-green-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <div class="flex space-x-3 mb-4 flex-wrap">
                        <select id="txFilterType" class="p-2 border border-gray-300 rounded-lg text-sm mb-2">
                            <option value="all">Semua Tipe</option>
                            <option value="Pengeluaran">Pengeluaran</option>
                            <option value="Pemasukan">Pemasukan</option>
                        </select>
                        <select id="txFilterCategory" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow mb-2">
                            <option value="all">Semua Kategori/Sumber</option>
                            </select>
                        <select id="txFilterAccount" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow mb-2">
                            <option value="all">Semua Akun/Dompet</option>
                            </select>
                    </div>

                    <div id="transactionsList" class="space-y-3 max-h-[70vh] overflow-y-auto">
                        <p class="text-gray-500 text-center p-4">Memuat transaksi...</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    /** Setup logika form Transaksi */
    function setupTransactionForm() {
        const form = document.getElementById('transactionForm');
        const txTypeSelect = document.getElementById('txType');
        const txCategorySelect = document.getElementById('txCategory');
        const categoryLabel = document.getElementById('categoryLabel');
        const categoryHint = document.getElementById('categoryHint');

        const filterCategorySelect = document.getElementById('txFilterCategory');
        const filterAccountSelect = document.getElementById('txFilterAccount');
        const searchInput = document.getElementById('txSearchInput');

        // Fungsi untuk mengupdate opsi kategori berdasarkan tipe transaksi
        function updateCategoryOptions() {
            const type = txTypeSelect.value;
            let options, labelText, hintText;

            if (type === 'Pengeluaran') {
                options = currentCategories.expense.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                labelText = 'Kategori Pengeluaran';
                hintText = 'Pilih kategori untuk pengeluaran ini.';
            } else { // Pemasukan
                options = currentCategories.incomeSource.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                labelText = 'Sumber Pemasukan';
                hintText = 'Pilih sumber dari pemasukan ini (e.g., Gaji, Investasi).';
            }
            
            txCategorySelect.innerHTML = options;
            categoryLabel.textContent = labelText;
            categoryHint.textContent = hintText;

            if (options === '') txCategorySelect.innerHTML = '<option value="">(Tambahkan kategori di Pengaturan)</option>';
        }
        
        // Fungsi untuk mengupdate opsi filter kategori & akun
        function updateFilterOptions() {
            if (filterCategorySelect) {
                const allCategories = [
                    ...currentCategories.expense.map(c => `<option value="${c}">[K] ${c}</option>`),
                    ...currentCategories.incomeSource.map(c => `<option value="${c}">[S] ${c}</option>`)
                ].join('');
                filterCategorySelect.innerHTML = `<option value="all">Semua Kategori/Sumber</option>` + allCategories;
                filterCategorySelect.addEventListener('change', renderTransactionsList);
            }
            
            if (filterAccountSelect) {
                const allAccounts = currentCategories.account.map(acc => `<option value="${acc}">${acc}</option>`).join('');
                filterAccountSelect.innerHTML = `<option value="all">Semua Akun/Dompet</option>` + allAccounts;
                filterAccountSelect.addEventListener('change', renderTransactionsList);
            }
        }

        // Listener untuk perubahan tipe transaksi
        txTypeSelect.addEventListener('change', updateCategoryOptions);

        // Listener untuk Search Input
        if (searchInput) {
            searchInput.addEventListener('input', renderTransactionsList);
        }

        // Inisialisasi awal
        updateCategoryOptions();
        updateFilterOptions();

        // Listener Submit Form
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const type = form.elements['type'].value;
            const amount = form.elements['amount'].value;
            const date = form.elements['date'].value;
            const category = form.elements['category'].value;
            const account = form.elements['account'].value; // Ambil Akun baru
            const description = form.elements['description'].value;

            if (!category) return showModal("Gagal", "Kategori/Sumber harus dipilih.");
            if (!account) return showModal("Gagal", "Akun/Dompet harus dipilih.");

            saveTransaction(type, amount, date, category, account, description);
        });
        
        // Listener Filter Tipe
        document.getElementById('txFilterType')?.addEventListener('change', renderTransactionsList);
    }

    /** Render Daftar Transaksi (sudah menyertakan Filter & Search) */
    function renderTransactionsList() {
        const container = document.getElementById('transactionsList');
        if (!container) return;

        const filterType = document.getElementById('txFilterType')?.value || 'all';
        const filterCategory = document.getElementById('txFilterCategory')?.value || 'all';
        const filterAccount = document.getElementById('txFilterAccount')?.value || 'all'; // Filter Akun Baru
        const searchTerm = document.getElementById('txSearchInput')?.value.toLowerCase().trim() || ''; 
        
        // Filter dan Urutkan
        const filtered = currentTransactions
            .filter(tx => (filterType === 'all' || tx.type === filterType))
            .filter(tx => (filterCategory === 'all' || tx.category === filterCategory))
            .filter(tx => (filterAccount === 'all' || tx.account === filterAccount)) // Filter Akun
            // Filter Search Bar 
            .filter(tx => {
                if (searchTerm === '') return true;
                const searchString = `${tx.description || ''} ${tx.category || ''} ${tx.account || ''}`.toLowerCase();
                return searchString.includes(searchTerm);
            })
            .sort((a, b) => new Date(b.date) - new Date(a.date));

        container.innerHTML = '';
        
        if (filtered.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center p-4">Tidak ada transaksi yang cocok dengan filter atau pencarian ini.</p>';
            return;
        }

        filtered.forEach(tx => {
            const isExpense = tx.type === 'Pengeluaran';
            const color = isExpense ? expenseColor : incomeColor;
            const sign = isExpense ? '-' : '+';
            
            const txEl = document.createElement('div');
            txEl.className = 'flex justify-between items-center p-3 rounded-lg card transition hover:shadow-md hover:border-gray-300';
            txEl.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold text-sm" style="color: ${color};">${tx.description || tx.category}</p>
                    <p class="text-xs text-gray-500">${tx.date} | ${tx.category} | Akun: ${tx.account || '-'}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <p class="font-bold text-sm ml-2" style="color: ${color};">${sign} ${formatRupiah(tx.amount).replace('Rp', '')}</p>
                    <button data-id="${tx.id}" class="delete-tx-btn text-red-400 hover:text-red-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            container.appendChild(txEl);
        });
        
        // Attach delete listener
        container.querySelectorAll('.delete-tx-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const txId = e.currentTarget.getAttribute('data-id');
                // Mengganti konfirmasi ke fungsi manageCategory yang sudah di-update
                showModal("Konfirmasi Hapus", "Anda yakin ingin menghapus transaksi ini?", true, () => deleteTransaction(txId));
            });
        });
    }

    
    /** Template Halaman Budget */
    function renderBudgetPageTemplate() {
        return `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 card p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-bold mb-4">Status Budget (Periode Ini)</h2>
                    <div id="budgetStatusContainerPage">
                         <p class="text-gray-500 text-center p-4">Memuat status budget...</p>
                    </div>
                </div>

                <div class="lg:col-span-2 card p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4">Atur Budget Pengeluaran Bulanan</h2>
                    
                    <div class="flex space-x-3 mb-4 items-center flex-wrap">
                        <label class="font-semibold text-gray-700">Periode Budget:</label>
                        <select id="budgetPeriodSelect" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow sm:flex-grow-0 min-w-[150px] mb-2 sm:mb-0">
                            </select>
                        <button id="setBudgetBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg shadow-md hover:shadow-lg">
                           Tampilkan Budget
                        </button>
                    </div>
                    
                    <form id="budgetForm" class="space-y-3 p-4 border rounded-xl bg-gray-50">
                        <div id="budgetInputs" class="space-y-3">
                            <p class="text-gray-500">Pilih periode di atas untuk mengatur budget.</p>
                        </div>
                        <button type="submit" class="btn-primary w-full text-white font-semibold py-2 rounded-lg mt-4 hidden" id="saveBudgetBtn">Simpan Budget</button>
                    </form>
                </div>
            </div>
        `;
    }

    /** Logika Halaman Budget */
    function renderBudgetPage() {
        // Render Status Budget di kiri (Ambil data dari Dashboard logic)
        const totalExpense = currentTransactions
            .filter(tx => tx.type === 'Pengeluaran' && tx.period === currentPeriod)
            .reduce((sum, tx) => sum + (tx.amount || 0), 0);
        
        const expenseMap = currentTransactions
            .filter(tx => tx.type === 'Pengeluaran' && tx.period === currentPeriod)
            .reduce((map, tx) => map.set(tx.category || 'Lain-lain', (map.get(tx.category || 'Lain-lain') || 0) + (tx.amount || 0)), new Map());
        
        // Tampilkan status budget di kontainer halaman Budget
        renderBudgetStatusPage(totalExpense, expenseMap); 
        
        // Logika Pengaturan Budget
        const budgetPeriodSelect = document.getElementById('budgetPeriodSelect');
        const budgetInputsContainer = document.getElementById('budgetInputs');
        const budgetForm = document.getElementById('budgetForm');
        
        if (!budgetPeriodSelect) return;

        // Populate Period Select (1 tahun ke depan/belakang)
        const currentMonth = new Date();
        budgetPeriodSelect.innerHTML = '';
        for (let i = -12; i <= 12; i++) {
            const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + i);
            const period = date.toISOString().substring(0, 7);
            const display = formatPeriod(period);
            const option = document.createElement('option');
            option.value = period;
            option.textContent = display;
            if (period === currentPeriod) option.selected = true;
            budgetPeriodSelect.appendChild(option);
        }

        // Fungsi untuk mengisi input budget berdasarkan periode yang dipilih
        function populateBudgetInputs() {
            const selectedPeriod = budgetPeriodSelect.value;
            const existingBudget = currentBudgets.find(b => b.period === selectedPeriod);
            const inputs = [];
            
            if (currentCategories.expense.length === 0) {
                 budgetInputsContainer.innerHTML = `<p class="text-red-500">Harap tambahkan Kategori Pengeluaran di halaman Pengaturan terlebih dahulu.</p>`;
                 document.getElementById('saveBudgetBtn').classList.add('hidden');
                 return;
            }

            currentCategories.expense.forEach(category => {
                const value = existingBudget?.budgets?.[category] || 0;
                inputs.push(`
                    <div>
                        <label for="budget-${category.replace(/\s/g, '_')}" class="block text-sm font-medium mb-1">${category}</label>
                        <input type="number" id="budget-${category.replace(/\s/g, '_')}" data-category="${category}" value="${value}" min="0" 
                               class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Budget untuk ${category}">
                    </div>
                `);
            });
            
            budgetInputsContainer.innerHTML = inputs.join('');
            document.getElementById('saveBudgetBtn').classList.remove('hidden');
        }

        // Event listener untuk tombol 'Set Budget'
        document.getElementById('setBudgetBtn').addEventListener('click', populateBudgetInputs);
        
        // Inisialisasi input budget saat halaman dimuat (untuk periode saat ini)
        populateBudgetInputs(); 

        // Listener Submit Form Budget
        budgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedPeriod = budgetPeriodSelect.value;
            const budgetInputs = budgetInputsContainer.querySelectorAll('input');
            const newBudgets = {};
            
            budgetInputs.forEach(input => {
                const category = input.getAttribute('data-category');
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    newBudgets[category] = amount;
                }
            });
            
            saveBudget(selectedPeriod, newBudgets); // Memanggil fungsi Supabase saveBudget
        });
    }

    /** Render Status Budget di Halaman Budget (Mirip Dashboard) */
    function renderBudgetStatusPage(totalExpense, expenseMap) {
        const budgetContainer = document.getElementById('budgetStatusContainerPage');
        if (!budgetContainer) return;

        budgetContainer.innerHTML = `<h3 class="text-lg font-bold mb-3">Budget Periode ${formatPeriod(currentPeriod)}</h3>`;
        
        const periodBudget = currentBudgets.find(b => b.period === currentPeriod);
        
        if (!periodBudget || Object.keys(periodBudget.budgets).length === 0) {
            budgetContainer.innerHTML += `<p class="text-gray-500 p-4 text-center">Belum ada budget yang ditetapkan untuk periode ini.</p>`;
            return;
        }

        let totalBudget = 0;
        let totalUsed = 0;
        let detailsHtml = '';

        Object.keys(periodBudget.budgets).forEach(category => {
            const budgetAmount = periodBudget.budgets[category] || 0;
            const usedAmount = expenseMap.get(category) || 0;
            
            totalBudget += budgetAmount;
            totalUsed += usedAmount;
            
            const remaining = budgetAmount - usedAmount;
            const usagePercentage = budgetAmount > 0 ? (usedAmount / budgetAmount) * 100 : 0;
            const progressBarColor = usagePercentage > 90 ? 'bg-red-500' : usagePercentage > 70 ? 'bg-yellow-500' : 'bg-green-500';
            const progressWidth = Math.min(usagePercentage, 100);

            detailsHtml += `
                <div class="mb-4 p-3 rounded-lg bg-white border border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm">${category}</span>
                        <span class="text-sm font-bold" style="color: ${remaining >= 0 ? incomeColor : expenseColor};">
                            ${formatRupiah(remaining)} tersisa
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mb-1">
                        ${formatRupiah(usedAmount)} dari ${formatRupiah(budgetAmount)}
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${progressBarColor}" style="width: ${progressWidth}%;"></div>
                    </div>
                </div>
            `;
        });
        
        // Ringkasan Total
        budgetContainer.innerHTML += `
            <div class="grid grid-cols-3 gap-2 text-center text-sm font-semibold mb-4 border-b pb-2">
                <p class="text-gray-700">Budget:</p>
                <p class="text-gray-700">Terpakai:</p>
                <p>Sisa:</p>
            </div>
            <div class="grid grid-cols-3 gap-2 text-center text-lg font-extrabold mb-4 pb-2 border-b">
                <p style="color: ${primaryAccent};">${formatRupiah(totalBudget)}</p>
                <p style="color: ${expenseColor};">${formatRupiah(totalUsed)}</p>
                <p style="color: ${totalBudget - totalUsed >= 0 ? incomeColor : expenseColor};">${formatRupiah(totalBudget - totalUsed)}</p>
            </div>
            <div class="mt-4">${detailsHtml}</div>
        `;
    }
    
    /** Template Halaman Pengaturan */
    function renderSettingsPageTemplate() {
        return `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
                    <h2 class="text-xl font-bold mb-4">Pengaturan Kategori & Sumber/Akun</h2>
                    
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3" style="color: ${expenseColor};">Kategori Pengeluaran (Expense)</h3>
                        <div id="expenseCategoryList" class="mb-4 space-y-2"></div>
                        <form id="addExpenseCategoryForm" class="flex space-x-2">
                            <input type="text" id="newExpenseCategory" placeholder="Nama Kategori Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                            <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
                        </form>
                    </div>

                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3" style="color: ${incomeColor};">Sumber Pemasukan (Income Source)</h3>
                        <div id="incomeSourceList" class="mb-4 space-y-2"></div>
                        <form id="addIncomeSourceForm" class="flex space-x-2">
                            <input type="text" id="newIncomeSource" placeholder="Nama Sumber Pemasukan Baru" required class="flex-grow p-2 border rounded-lg text-sm">
                            <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
                        </form>
                    </div>

                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3" style="color: ${balanceColor};">Akun / Dompet (Account)</h3>
                        <div id="accountList" class="mb-4 space-y-2"></div>
                        <form id="addAccountForm" class="flex space-x-2">
                            <input type="text" id="newAccount" placeholder="Nama Akun/Dompet Baru (e.g., Kas, Bank)" required class="flex-grow p-2 border rounded-lg text-sm">
                            <button type="submit" class="btn-primary text-white py-2 px-3 rounded-lg text-sm">Tambah</button>
                        </form>
                        <p class="text-xs text-gray-500 mt-2">Ini adalah tempat fisik uang Anda berada.</p>
                    </div>
                </div>

                <div class="lg:col-span-1 card p-6 rounded-xl space-y-6">
                    <h2 class="text-xl font-bold mb-4">Pengaturan Lain</h2>

                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold mb-3">Pilih Tema Aplikasi</h3>
                        <p class="text-sm text-gray-600">Saat ini menggunakan tema Default (Hijau Soft). Fitur kustomisasi tema akan hadir segera.</p>
                        <div class="flex space-x-3 mt-3">
                             <button class="bg-gray-300 py-2 px-4 rounded-lg text-sm opacity-50 cursor-not-allowed">Default (Aktif)</button>
                             <button class="bg-gray-300 py-2 px-4 rounded-lg text-sm opacity-50 cursor-not-allowed">Gelap</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /** Logika Halaman Pengaturan (Kategori) */
    function renderSettingsPage() {
        // Render Daftar Kategori Pengeluaran
        const expenseList = document.getElementById('expenseCategoryList');
        if (expenseList) {
            expenseList.innerHTML = currentCategories.expense.map(cat => `
                <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-red-100">
                    <span>${cat}</span>
                    <button data-name="${cat}" data-type="expense" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
                </div>
            `).join('');
        }
        
        // Render Daftar Sumber Pemasukan
        const incomeSourceList = document.getElementById('incomeSourceList');
        if (incomeSourceList) {
            incomeSourceList.innerHTML = currentCategories.incomeSource.map(cat => `
                <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-green-100">
                    <span>${cat}</span>
                    <button data-name="${cat}" data-type="incomeSource" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
                </div>
            `).join('');
        }

        // Render Daftar Akun
        const accountList = document.getElementById('accountList');
        if (accountList) {
            accountList.innerHTML = currentCategories.account.map(cat => `
                <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-blue-100">
                    <span>${cat}</span>
                    <button data-name="${cat}" data-type="account" class="delete-cat-btn text-red-500 hover:text-red-700 transition">Hapus</button>
                </div>
            `).join('');
        }
        
        // Setup Form Submits
        document.getElementById('addExpenseCategoryForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('newExpenseCategory');
            manageCategory('expense', 'add', input.value);
            input.value = '';
        });
        
        document.getElementById('addIncomeSourceForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('newIncomeSource');
            manageCategory('incomeSource', 'add', input.value);
            input.value = '';
        });

        document.getElementById('addAccountForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('newAccount');
            manageCategory('account', 'add', input.value);
            input.value = '';
        });
        
        // Setup Delete Buttons
        document.querySelectorAll('.delete-cat-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const name = e.currentTarget.getAttribute('data-name');
                const type = e.currentTarget.getAttribute('data-type');
                
                // Panggil manageCategory untuk menghapus (ada logic konfirmasi di sana)
                manageCategory(type, 'delete', name); 
            });
        });
    }

    // ----------------------------------------------------------------------
    // PERIOD CONTROL
    // ----------------------------------------------------------------------
    
    /** Memperbarui tampilan periode saat ini */
    function updatePeriodDisplay(period) {
        const displayEl = document.getElementById('currentPeriodDisplay');
        if (displayEl) {
            displayEl.textContent = `Periode: ${formatPeriod(period)}`;
        }
    }

    /** Menambah atau mengurangi periode bulan */
    function changePeriod(offset) {
        const [year, month] = currentPeriod.split('-').map(Number);
        const date = new Date(year, month - 1);
        
        date.setMonth(date.getMonth() + offset);
        
        const newYear = date.getFullYear();
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        
        currentPeriod = `${newYear}-${newMonth}`;
        
        // Muat ulang hanya dashboard jika sedang berada di dashboard
        if (currentPage === 'dashboard') {
            loadDashboard(currentPeriod);
        } else if (currentPage === 'budget') {
            renderBudgetPage();
        }
    }
    
    // ----------------------------------------------------------------------
    // INVOCATION
    // ----------------------------------------------------------------------
    
    // Setup Event Listeners untuk Navigasi Menu
    document.querySelectorAll('.nav-link').forEach(button => {
        button.addEventListener('click', (e) => {
            renderPage(e.target.getAttribute('data-page'));
        });
    });
    
    // Mulai inisialisasi Supabase saat dokumen siap (PERBAIKAN ERROR WINDOW.ONLOAD)
    window.onload = initializeSupabase;
    
    // Tambahkan listener untuk merespon perubahan ukuran window (untuk chart)
    window.addEventListener('resize', () => {
        if (currentPage === 'dashboard' && isAuthReady) {
            // Memuat ulang chart yang responsif terhadap perubahan ukuran
            loadDashboard(currentPeriod);
        }
    });

  </script>
</body>
</html>
